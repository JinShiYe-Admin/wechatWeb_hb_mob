<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="../../../js/demoCssJs/weui.min.css">
		<link rel="stylesheet" href="../../../js/demoCssJs/jquery-weui.css">
		<link rel="stylesheet" href="../../../js/demoCssJs/demos.css">
		<link rel="stylesheet" href="../../../css/demos.css" />
		<style type="text/css">
			body,
			html {
				width: 100%;
				height: 100%;
				margin: 0;
				font-family: "微软雅黑";
			}
			
			#allmap {
				width: 100%;
				height: 50%;
			}
			
			p {
				margin-left: 5px;
				font-size: 14px;
			}
		</style>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=VPMK2gwQeEtGyV24Py1Gb4GTpukyjm6y"></script>
		<!--加载鼠标绘制工具-->
		<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
		<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
		<title>签到考勤</title>
	</head>

	<body>
		<div style="margin: 10px;">
			<span>
			当前位置：
		</span>
			<span id="tempAddress">
		</span>
		
		</div>
			<input  style="margin-bottom: 10px;"  onclick="refresh()" type="button" name="refresh" id="refresh" value="点击刷新当前位置" />
		<div id="allmap"></div>
		<!--<div style="margin: 10px;visibility: hidden;">
			<span>
			距离：
		</span>
			<span id="distance">
		</span>
		</div>

		<div style="margin: 10px;visibility: hidden;">
			<span>
			经度：
		</span>
			<span id="longitude">
		</span>
		</div>

		<div style="margin: 10px;visibility: hidden;">
			<span>
			纬度：
		</span>
			<span id="latitude">
		</span>
		</div>-->

		<div class="weui-cell">
			<div class="weui-cell__hd"><label class="weui-label">考勤类型</label></div>
			<div class="weui-cell__bd">
				<input id="attendType" data_id="" onclick="selectAttendType(this)" class="weui-input" placeholder="请选择考勤类型">
			</div>
		</div>
		<div class="weui-cell">
			<div class="weui-cell__hd"><label class="weui-label">部门</label></div>
			<div class="weui-cell__bd">
				<input id="depart" data_id="" onclick="selectDepart(this)" class="weui-input" placeholder="请选择部门">
			</div>
		</div>

		<div class="weui-cell">
			<div class="weui-cell__hd"><label class="weui-label">考勤地点</label></div>
			<div class="weui-cell__bd">
				<input id="attendArea" data_id="" onclick="selectAttendArea(this)" class="weui-input" placeholder="请选择部门">
			</div>
		</div>

		<div style="margin-top: 20px;">
			<span>
			<input onclick="save()" type="button" name="save" id="save" value="签到" />
		</span>
			<span>
			<input  onclick="history()" type="button" name="history" id="history" value="签到记录" />
		</span>
			
		</div>
		<div>

		</div>
		<script src="../../../js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../js/demoCssJs/jquery-2.1.4.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../js/demoCssJs/iscroll.js"></script>
		<script src="../../../js/demoCssJs/jquery-weui.js"></script>
		<script src="../../../js/weui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../js/PublicProtocol.js"></script>
		<script src="../../../js/utils/utils.js"></script>
		<script src="../../../js/utils/storageutil.js"></script>
		<script src='../../../js/lib/vconsole/vconsole.min.js'></script>

	</body>

</html>

<script type="text/javascript">
	setMap();
	var userList = [];
	var userInfo = {};
	var attendType = {
		tempAttendType: '',
		attendTypeList: []
	}
	var attendTime = {
		tempAttendTime: '',
		attendTimeList: []
	}
	var attendArea = {
		tempAttendArea: {},
		attendAreaList: []
	}

	getUserInfo();
	getDepart();
	//签到
	function save() {
		addAttend(attendType.tempAttendType);
		console.log('签到')
	}
	//签到记录
	function history() {
		utils.wOpenWithData('getAttendList.html','')
		console.log('签到记录')
	}

	//12.获取考勤类型
	function getAttendType() {
		var tempData = {
			corpId: userInfo.corpid, //单位ID
			//			corpId: "wx6c4528c675d4a9c9",
			pageIndex: '1', //当前页数
			pageSize: '0' //每页记录数，0 为全部
		}
		console.log('获取考勤类型参数:' + JSON.stringify(tempData));
		getAttendTypePro(tempData, function(data) {
			console.log('获取考勤类型数据:' + JSON.stringify(data));
			if(data.RspCode == 0) {

				for(var i = 0; i < data.RspData.Data.length; i++) {
					var model = data.RspData.Data[i];
					model.label = model.AttendTypeNote;
					model.value = model.AttendTypeId;
					attendType.attendTypeList.push(model);

				}
				console.log('重组考勤类型:' + JSON.stringify(attendType.attendTypeList));

			} else {
				alert(data.RspTxt);
			}
		});
	};

	function getAttendArea() {
		var tempData = {
			corpId: userInfo.corpid, //单位ID
			//			corpId: "wx6c4528c675d4a9c9",
			pageIndex: 1, //当前页数
			pageSize: 0 //每页记录数，0 为全部
		}
		console.log('获取考勤地点参数:' + JSON.stringify(tempData));
		getAttendAreaPro(tempData, function(data) {
			console.log('获取考勤地点数据:' + JSON.stringify(data));
			if(data.RspCode == 0) {

				for(var i = 0; i < data.RspData.Data.length; i++) {
					var model = data.RspData.Data[i];
					model.label = model.AreaName;
					model.value = model.AttendAreaId;
					attendArea.attendAreaList.push(model);

				}

				console.log('重组考勤地点:' + JSON.stringify(attendType.attendTypeList));

			} else {
				alert(data.RspTxt);
			}
		});
	}

	function addAttend(tempAttendType) {
		var tempData = {
			corpId: userInfo.corpid,
			deptId: document.getElementById("depart").data_id,
			userId: userInfo.userid,
			userName: userInfo.name,
			attendType: document.getElementById("attendType").data_id,
			attendArea: document.getElementById("attendArea").data_id,
			attendAreaX: attendArea.tempAttendArea.lng,
			attendAreaY: attendArea.tempAttendArea.lat,
			attendPic: '',
			attendNote: '测试接口',
		}
		console.log('添加考勤参数：' + JSON.stringify(tempData));

		addAttendPro(tempData, function(data) {
			console.log('添加考勤：' + JSON.stringify(data))
			if(data.RspCode == 0) {
				alert('添加成功')
			} else {
				alert(data.RspTxt)
			}
		})
	}

	function getUserInfo() {
		var tempData = {
			cmd: 'userinfo',
			type: 'findpage',
			colv: ''
		}
		console.log(JSON.stringify(tempData))
		unitWebsitePro(tempData, function(data) {
			console.log('获取当前人员信息' + JSON.stringify(data.RspData))
			if(data.RspCode == 0) {
				userInfo = JSON.parse(data.RspData);
				getAttendType();
				getAttendArea();
			} else {
				alert(data.RspTxt)
			}
		})
	}

	function selectDepart(input_item) {
		document.activeElement.blur();
		var self = input_item;
		weui.picker(userInfo.depart_array, {
			onChange: function(result) {
				//						console.log(result);
			},
			onConfirm: function(result) {
				document.getElementById("depart").value = result[0].label;
				document.getElementById("depart").data_id = result[0].value;
			}
		});
	}

	function selectAttendArea(input_item) {
		document.activeElement.blur();
		var self = input_item;
		weui.picker(attendArea.attendAreaList, {
			onChange: function(result) {
				//						console.log(result);
			},
			onConfirm: function(result) {
				document.getElementById("attendArea").value = result[0].label;
				document.getElementById("attendArea").data_id = result[0].value;
			}
		});
	}

	function selectAttendType(input_item) {
		document.activeElement.blur();
		var self = input_item;
		weui.picker(attendType.attendTypeList, {
			onChange: function(result) {
				//						console.log(result);
			},
			onConfirm: function(result) {

				document.getElementById("attendType").value = result[0].label;
				document.getElementById("attendType").data_id = result[0].value;
			}
		});
	}

	function getDepart() {

		var tempData = {
			cmd: 'persondeparts',
			type: 'findpage',
		}
		unitWebsitePro(tempData, function(data) {
			console.log('部门:' + JSON.stringify(data));
			var rspData = JSON.parse(data.RspData);
			if(data.RspCode == 0) {
				userInfo.depart_array = [];
				for(var i = 0; i < rspData.length; i++) {
					var model = rspData[i];
					if(model.value == -1) {
						continue;
					} else {
						model.label = model.title;
						userInfo.depart_array.push(model);
					}
				}
				console.log('重组部门:' + JSON.stringify(userInfo.depart_array));

			} else {
				alert(data.RspTxt)
			}
		})

	}

	function setMap() {
		// 百度地图API功能
		var map = new BMap.Map("allmap"); // 创建地图实例
		var geolocation = new BMap.Geolocation();
		geolocation.getCurrentPosition(function(r) {
			if(this.getStatus() == BMAP_STATUS_SUCCESS) {
				var mk = new BMap.Marker(r.point);
				map.addOverlay(mk);
				map.panTo(r.point);
				var myGeo = new BMap.Geocoder();

				myGeo.getLocation(r.point, function(result) {
					if(result) {
						map.centerAndZoom(r.point, 15); // 初始化地图，设置中心点坐标和地图级别
						map.enableScrollWheelZoom();
						map.addControl(new BMap.NavigationControl()); //添加默认缩放平移控件
						var addComp = result.addressComponents;
						attendArea.tempAttendArea = r.point;
						document.getElementById("tempAddress").innerHTML = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;

						//						document.getElementById("longitude").innerHTML = r.point.lng;
						//						document.getElementById("latitude").innerHTML = r.point.lat;
						//						document.getElementById("distance").innerHTML = map.getDistance(r.point, new BMap.Point(117.021629, 36.681578));
					}
				});

				//			alert('您的位置：' + r.point.lng + ',' + r.point.lat);
			} else {
				alert('failed' + this.getStatus());
			}
		}, {
			enableHighAccuracy: true
		})

	}

	function refresh() {
		console.log('刷新')
		var geolocation = new BMap.Geolocation();
		geolocation.getCurrentPosition(function(r) {
			if(this.getStatus() == BMAP_STATUS_SUCCESS) {
				var mk = new BMap.Marker(r.point);
				map.addOverlay(mk);
				map.panTo(r.point);
				var myGeo = new BMap.Geocoder();
				myGeo.getLocation(r.point, function(result) {
					if(result) {
						var addComp = result.addressComponents;
						attendArea.tempAttendArea = r.point;
						document.getElementById("tempAddress").innerHTML = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;

						//						document.getElementById("longitude").innerHTML = r.point.longitude;
						//						document.getElementById("latitude").innerHTML = r.point.latitude;
						//						document.getElementById("distance").innerHTML = map.getDistance(r.point, new BMap.Point(117.021629, 36.681578));
					}
				});

				//			alert('您的位置：' + r.point.lng + ',' + r.point.lat);
			} else {
				alert('failed' + this.getStatus());
			}
		}, {
			enableHighAccuracy: true
		})
	}
</script>