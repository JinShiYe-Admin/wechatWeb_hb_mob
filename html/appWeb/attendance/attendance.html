<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="../../../css/weui.min.css" />
		<link rel="stylesheet" href="../../../css/jquery-weui.min.css" />
		<link rel="stylesheet" href="../../../css/demos.css" />
		<link rel="stylesheet" href="https://jsypay.jiaobaowang.net/suitetest/css/utils/iconfont.css" />
		<style type="text/css">
			body,
			html {
				width: 100%;
				height: 100%;
				margin: 0;
				font-family: "微软雅黑";
			}
			
			#allmap {
				width: 100%;
				height: 50%;
			}
			
			p {
				margin-left: 5px;
				font-size: 14px;
			}
		</style>
		<script type='text/javascript' src='../../../js/PublicProtocol.js'></script>
		<script src="../../../js/lib/vconsole/vconsole.min.js"></script>

		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=jYNU39RZ3k37NUz1QduizaYD"></script>
		<!--加载鼠标绘制工具-->
		<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
		<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />
		<title>签到考勤</title>
	</head>

	<body>
		<div style="margin: 10px;">
			<span>
			当前位置：
		</span>
			<span id="tempAddress">
		</span>
		</div>
		<div style="margin: 10px;">
			<span>
			距离：
		</span>
			<span id="distance">
		</span>
		</div>

		<div style="margin: 10px;">
			<span>
			经度：
		</span>
			<span id="longitude">
		</span>
		</div>

		<div style="margin: 10px;">
			<span>
			纬度：
		</span>
			<span id="latitude">
		</span>
		</div>

		<div class="weui-tab">
			<div class="weui-tab__bd">
				<div class="weui-tab__bd-item weui-tab__bd-item--active">
					<div>
						<div class="weui-cell">
							<div class="weui-cell__hd"><label class="weui-label">考勤类型</label></div>
							<div class="weui-cell__bd">
								<input id="attendType" data_id="" onclick="selectAttendType(this)" class="weui-input" placeholder="请选择考勤类型">
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd"><label class="weui-label">部门</label></div>
							<div class="weui-cell__bd">
								<input id="depart" data_id="" onclick="selectDepart(this)" class="weui-input" placeholder="请选择部门">
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>

		<div id="allmap"></div>
		<div style="margin-top: 20px;">
			<span>
			<input onclick="save()" type="button" name="save" id="save" value="签到" />
		</span>
			<span>
			<input  onclick="history()" type="button" name="history" id="history" value="签到记录" />
		</span>
			<span>
			<input  onclick="refresh()" type="button" name="refresh" id="refresh" value="刷新" />
		</span>
		</div>
		<div>

		</div>

	</body>

</html>
<script src="../../../js/weui.min.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
	var userInfo = {};
	var attendType = {
		tempAttendType: '',
		attendTypeList: []
	}
	getUserInfo();

	function save() {
		addAttend(attendType.tempAttendType);
		console.log('签到')
	}

	function history() {
		console.log('签到记录')
	}

	function refresh() {
		console.log('刷新')
		var geolocation = new BMap.Geolocation();
		geolocation.getCurrentPosition(function(r) {
			if(this.getStatus() == BMAP_STATUS_SUCCESS) {
				var mk = new BMap.Marker(r.point);
				map.addOverlay(mk);
				map.panTo(r.point);
				var myGeo = new BMap.Geocoder();
				myGeo.getLocation(r.point, function(result) {
					if(result) {
						var addComp = result.addressComponents;
						document.getElementById("longitude").innerHTML = r.point.longitude;
						document.getElementById("latitude").innerHTML = r.point.latitude;
						document.getElementById("tempAddress").innerHTML = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
						document.getElementById("distance").innerHTML = map.getDistance(r.point, new BMap.Point(117.021629, 36.681578));
					}
				});

				//			alert('您的位置：' + r.point.lng + ',' + r.point.lat);
			} else {
				alert('failed' + this.getStatus());
			}
		}, {
			enableHighAccuracy: true
		})
	}
	// 百度地图API功能
	var map = new BMap.Map("allmap"); // 创建地图实例
	var geolocation = new BMap.Geolocation();
	geolocation.getCurrentPosition(function(r) {
		if(this.getStatus() == BMAP_STATUS_SUCCESS) {
			var mk = new BMap.Marker(r.point);
			map.addOverlay(mk);
			map.panTo(r.point);
			var myGeo = new BMap.Geocoder();
			myGeo.getLocation(r.point, function(result) {
				if(result) {
					var addComp = result.addressComponents;
					document.getElementById("longitude").innerHTML = r.point.lng;
					document.getElementById("latitude").innerHTML = r.point.lat;
					document.getElementById("tempAddress").innerHTML = addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber;
					document.getElementById("distance").innerHTML = map.getDistance(r.point, new BMap.Point(117.021629, 36.681578));
				}
			});

			//			alert('您的位置：' + r.point.lng + ',' + r.point.lat);
		} else {
			alert('failed' + this.getStatus());
		}
	}, {
		enableHighAccuracy: true
	})
	var point = new BMap.Point(117.021629, 36.681578); // 创建点坐标
	var mk1 = new BMap.Marker(point);
	map.addOverlay(mk1);
	map.panTo(point);
	mk1.addEventListener("click", function() {
		var opts = {
			width: 200, // 信息窗口宽度    
			height: 80, // 信息窗口高度    
			title: "签到地址" // 信息窗口标题   
		}
		var infoWindow = new BMap.InfoWindow("山东省济南市天桥区铜元局前街1-6", opts); // 创建信息窗口对象    
		map.openInfoWindow(infoWindow, point); // 打开信息窗口   
	});

	var options = {
		renderOptions: {
			map: map
		},
		onSearchComplete: function(results) {
			//			alert('Search Completed');
			//可添加自定义回调函数
		}
	};
	var localSearch = new BMap.LocalSearch(map, options);
	map.addEventListener("load", function() {
		var circle = new BMap.Circle(point, 500, {
			fillColor: "blue",
			strokeWeight: 1,
			fillOpacity: 0.3,
			strokeOpacity: 0.3
		});
		map.addOverlay(circle);
	});
	map.centerAndZoom(point, 15); // 初始化地图，设置中心点坐标和地图级别
	map.enableScrollWheelZoom();
	map.addControl(new BMap.NavigationControl()); //添加默认缩放平移控件

	var drawingManager = new BMapLib.DrawingManager(map, {
		isOpen: false, //是否开启绘制模式
		enableDrawingTool: true, //是否显示工具栏
		drawingToolOptions: {
			anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
			offset: new BMap.Size(5, 5), //偏离值
			scale: 0.8, //工具栏缩放比例
			drawingModes: [
				BMAP_DRAWING_CIRCLE
			]
		}
	});
	var circle = null;
	drawingManager.addEventListener('circlecomplete', function(e, overlay) {
		//	circlecomplete
		map.clearOverlays();
		circle = e;
		map.addOverlay(overlay);
		var radius = parseInt(e.getRadius());
		var center = e.getCenter();
		drawingManager.close();
		localSearch.searchNearby('积水点', center, radius, {
			customData: {
				geotableId: 91687
			}
		});
	});
	//12.获取考勤类型
	var getAttendType = function() {
		var tempData = {
			corpId: userInfo.corpid, //单位ID
			pageIndex: 1, //当前页数
			pageSize: 0 //每页记录数，0 为全部
		}
		console.log('获取考勤类型:' + JSON.stringify(tempData));
		getAttendTypePro(tempData, function(data) {
			if(data.RspCode == 0) {
				for(var i = 0; i < data.RspData.Data.length; i++) {
					var model = data.RspData.Data[i];
					model.label = model.attendTypeProp;
					model.value = model.AttendTypeId;
					attendType.attendTypeList.push(model);

				}
	
			} else {
				//						layer.alert('请重新登录获取个人信息');
			}
		});
	};

	function addAttend(tempAttendType) {
		var tempData = {
			corpId: userInfo.corpid,
			deptId: document.getElementById("depart").data_id,
			userId: userInfo.userid,
			userName: userInfo.name,
			attendType: document.getElementById("attendType").data_id,
			attendArea: document.getElementById("tempAddress").innerHTML,
			attendAreaX: document.getElementById("longitude").innerHTML,
			attendAreaY: document.getElementById("latitude").innerHTML,
			attendPic: '',
			attendNote: '测试接口',
		}
		console.log('添加考勤参数：' + JSON.stringify(tempData));

		addAttendPro(tempData, function(data) {
			console.log('添加考勤：' + JSON.stringify(data))
			if(data.RspCode == 0) {
				alert('添加成功')
			} else {
				mui.toast(data.RspTxt)
			}
		})
	}

	function getUserInfo() {
		var tempData = {
			cmd: 'userinfo',
			type: 'findpage',
			colv: ''
		}
		console.log(JSON.stringify(tempData))
		unitWebsitePro(tempData, function(data) {
			console.log('获取当前人员信息' + JSON.stringify(data.RspData))
			if(data.RspCode == 0) {
				userInfo = JSON.parse(data.RspData);
				getAttendType()
			} else {
				alert(data.RspTxt)
			}
		})
	}

	function selectDepart(input_item) {
		document.activeElement.blur();
		var self = input_item;
		weui.picker(userInfo.depart_array, {
			onChange: function(result) {
				//						console.log(result);
			},
			onConfirm: function(result) {
				document.getElementById("depart").value = result[0].label;
				document.getElementById("depart").data_id = result[0].value;
			}
		});
	}
	
	function selectAttendType(input_item) {
		document.activeElement.blur();
		var self = input_item;
		weui.picker(attendType.attendTypeList, {
			onChange: function(result) {
				//						console.log(result);
			},
			onConfirm: function(result) {
				
				document.getElementById("attendType").value = result[0].label;
				document.getElementById("attendType").data_id = result[0].value;
			}
		});
	}

	function getDepart() {

		var tempData = {
			cmd: 'persondeparts',
			type: 'findpage',
		}
		unitWebsitePro(tempData, function(data) {
			console.log('部门:' + JSON.stringify(data));
			var rspData = JSON.parse(data.RspData);
			if(data.RspCode == 0) {
				userInfo.depart_array = [];
				for(var i = 0; i < rspData.length; i++) {
					var model = rspData[i];
					if(model.value == -1) {
						continue;
					} else {
						model.label = model.title;
						userInfo.depart_array.push(model);
					}
				}

			} else {
				mui.toast(data.RspTxt)
			}
		})

	}
</script>