<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>学生点评</title>
		<script type="text/javascript">
			var WebVersion = "?" + Math.random();
		</script>
		<link rel="stylesheet" href="../../../css/weui.min.css" />
		<link rel="stylesheet" href="../../../js/demoCssJs/jquery-weui.min.css" />
		<link rel="stylesheet" href="../../../js/demoCssJs/demos.css" />
		<style>
			body {
				-webkit-overflow-scrolling: touch;
			}

			.weui-tab__bd-item {
				width: 100%;
			}

			.weui-tab__bd {
				margin-top: -50px;
			}

			.weui-tabbar {
				bottom: -50px;
			}

			.weui-cells {
				margin-top: 0;
			}

			.weui-media-box {
				padding: 0;
			}
		</style>
	</head>

	<body>
		<div class="weui-tab">
			<div class="weui-tab__bd">
				<div class="weui-tab__bd-item weui-tab__bd-item--active weui-pull-to-refresh">
					<div id="pullDown" class="weui-pull-to-refresh__layer" style="display: none;">
						<div class='weui-pull-to-refresh__arrow'></div>
						<div class='weui-pull-to-refresh__preloader'></div>
						<div class="down">下拉刷新</div>
						<div class="up">释放刷新</div>
						<div class="refresh">正在刷新</div>
					</div>
					<div id="dataList" class="weui-cells weui-form-preview"></div>
				</div>
			</div>
			<div class="weui-tabbar">
				<a href="https://jsypay.jiaobaowang.net/wxth/appschweb/app/index.aspx" class="weui-tabbar__item">
					<div class="weui-tabbar__icon">
						<img class="img" src="../../../image/utils/wxhome.png">
					</div>
					<p class="weui-tabbar__label">微校园</p>
				</a>
				<a href="classlist.html" class="weui-tabbar__item weui-bar__item--on">
					<div class="weui-tabbar__icon">
						<img class="img" src="../../../image/comment/startactive.png">
					</div>
					<p class="weui-tabbar__label">学生点评</p>
				</a>
			</div>
		</div>
		<script type="text/javascript" src="../../../js/lib/vconsole/vconsole.min.js"></script>
		<script type="text/javascript" src="../../../js/demoCssJs/jquery-2.1.4.js"></script>
		<script type="text/javascript" src="../../../js/demoCssJs/jquery-weui.min.js"></script>
		<script type="text/javascript">
			document.write("<s" + "cript type='text/javascript' src='../../../js/PublicProtocol.js" + WebVersion + "'></s" + "cript>");
			document.write("<s" + "cript type='text/javascript' src='../../../js/utils/utils.js" + WebVersion + "'></s" + "cript>");
			document.write("<s" + "cript type='text/javascript' src='../../../js/utils/storageutil.js" + WebVersion + "'></s" + "cript>");
			//document.write("<s" + "cript type='text/javascript' src='../../../temp/mineinfo.js" + WebVersion + "'></s" + "cript>");
		</script>
		<script>
			var loading = false; //下拉状态标记
			var mineUserInfo; //个人信息
			window.onload = function() {
				$.showLoading();
				getMineInfo();
			}

			function initListener() {
				//点击班级
				$("#dataList").on("click", ".weui-cell", function() {
					var deptId = this.getAttribute("id");
					var deptName = this.getAttribute("title");
					var data = {
						deptId: deptId,
						deptName: deptName,
						mineUserInfo: mineUserInfo
					}
					var href;
					if(mineUserInfo.isleader == 1) {
						href = "stulist.html";
					} else {
						href = "commentDetail.html";
					}
					utils.hrefSessionStorage(href, data);
				});

				//下拉刷新
				$("#pullDown").css("display", "block");
				$(".weui-tab__bd-item").pullToRefresh();
				$(".weui-tab__bd-item").on("pull-to-refresh", function() {
					if(loading) {
						return false
					};
					loading = true;
					getDepartments();
				});
			}
			/**
			 * 获取我的信息
			 */
			function getMineInfo() {
				var tempData = {
					cmd: 'userinfo',
					type: 'findpage',
					colv: ""
				}
				unitWebsitePro(tempData, function(data) {
					//data = getMineInfoCallBack;
					if(data.RspCode == 0) {
						mineUserInfo = JSON.parse(data.RspData);
						initListener();
						getDepartments();
					} else {
						$.hideLoading();
						$.alert("未获取到个人信息(" + data.RspTxt + ")", "提示");
					}
				});
			}

			/**
			 * 获取部门
			 */
			function getDepartments() {
				var tempData = {
					cmd: 'persondeparts',
					type: 'findpage',
				}
				unitWebsitePro(tempData, function(data) {
					//data = persondepartsCallBack;
					$.hideLoading();
					loading = false;
					$(".weui-tab__bd-item").pullToRefreshDone();
					if(data.RspCode == 0) {
						$("#dataList").empty();
						var departments = JSON.parse(data.RspData);
						var mineDepart = [];
						for(var i = 0; i < mineUserInfo.department.length; i++) {
							for(var j = 0; j < departments.length; j++) {
								if(departments[j].value == mineUserInfo.department[i]) {
									mineDepart.push(departments[j]);
									break;
								}
							}
						}
						console.log("departments", departments, mineDepart);
						showData(mineDepart);
					} else {
						$.alert(data.RspTxt, "提示");
					}
				});
			}

			function showData(departments) {
				var html = "";
				for(var i = 0; i < departments.length; i++) {
					if(departments[i].value == -1) {
						continue;
					} else {
						html = html + '\
							<a id="' + departments[i].value + '" title="' + departments[i].title + '" class="weui-cell weui-cell_access">\
								<div class="weui-cell__bd">\
									<div class="weui-media-box weui-media-box_appmsg">\
										<div class="weui-media-box__bd">\
											<h4 class="weui-media-box__title">' + departments[i].title + '</h4>\
										</div>\
									</div>\
								</div>\
								<div class="weui-cell__ft">\
								</div>\
							</a>';
					}
				}
				$("#dataList").append(html);
			}
		</script>
	</body>

</html>