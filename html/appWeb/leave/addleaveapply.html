<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>请假申请</title>
		<script type="text/javascript">
			var WebVersion = "?" + Math.random();
		</script>
		<link rel="stylesheet" href="../../../css/weui.min.css" />
		<link rel="stylesheet" href="../../../js/demoCssJs/jquery-weui.min.css" />
		<link rel="stylesheet" href="../../../js/demoCssJs/demos.css" />

		<style>
			.weui-cells {
				margin-top: 0;
				margin-bottom: 50px;
			}

			.weui-uploader__title {
				color: #999;
			}

			.weui-btn_primary {
				margin-left: 5%;
				width: 90%;
				background-color: #46BDFF;
				border-color: #46BDFF;
				margin-top: 10px;
			}

			.weui-btn_disabled.weui-btn_primary {
				background-color: #46BDFF;
				border-color: #46BDFF;
				opacity: .5;
			}

			.weui-btn_primary:not(.weui-btn_disabled):active {
				background-color: #46BDFF;
				border-color: #46BDFF;
				opacity: .5;
			}

			.weui-cells:after {
				border-bottom: none;
			}

			.weui-tab__bd .weui-tab__bd-item {
				width: 100%;
			}

			.weui-cell.weui-check_label {
				text-align: center;
			}
		</style>
	</head>

	<body>
		<div class="weui-tab">
			<div class="weui-tab__bd">
				<div class="weui-tab__bd-item weui-tab__bd-item--active weui-pull-to-refresh">
					<div class="weui-cells weui-cells_form">
						<div class="weui-cell weui-cell_access">
							<div class="weui-cell__hd"><label class="weui-label" for="selectTypeFirstInput">流程类型</label></div>
							<div class="weui-cell__bd">
								<input id="selectTypeFirstInput" class="weui-input" placeholder="选取流程类型" readonly="readonly" />
							</div>
							<div class="weui-cell__ft">
							</div>
						</div>
						<div class="weui-cell weui-cell_access">
							<div class="weui-cell__hd"><label class="weui-label" for="selectTypeSecondInput">请假类型</label></div>
							<div class="weui-cell__bd">
								<input id="selectTypeSecondInput" class="weui-input" placeholder="选取请假类型" readonly="readonly" />
							</div>
							<div class="weui-cell__ft">
							</div>
						</div>
						<div class="weui-cell weui-cell_access">
							<div class="weui-cell__hd"><label class="weui-label" for="selectTypeThirdInput">开始时间</label></div>
							<div class="weui-cell__bd">
								<input id="selectTypeThirdInput" class="weui-input" placeholder="选取开始时间" readonly="readonly" />
							</div>
							<div class="weui-cell__ft">
							</div>
						</div>
						<div class="weui-cell weui-cell_access">
							<div class="weui-cell__hd"><label class="weui-label" for="selectTypeFourthInput">结束时间</label></div>
							<div class="weui-cell__bd">
								<input id="selectTypeFourthInput" class="weui-input" placeholder="选取结束时间" readonly="readonly" />
							</div>
							<div class="weui-cell__ft">
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<textarea id="represon" class="weui-textarea" placeholder="请输入请假事由，最多100字" rows="4" maxlength="100"></textarea>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<div class="weui-uploader">
									<div class="weui-uploader__hd">
										<p class="weui-uploader__title">添加图片</p>
										<div id="imageAmount" class="weui-uploader__info">0/9</div>
									</div>
									<div class="weui-uploader__bd">
										<ul id="uploaderFiles" class="weui-uploader__files"></ul>
										<div class="weui-uploader__input-box">
											<input id="addImage" class="weui-uploader__input" accept="image/*" type="file">
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="weui-btn-area">
							<a id="submitForm" class="weui-btn weui-btn_primary weui-btn_disabled" style="display: none;">提交请假申请</a>
						</div>
					</div>
				</div>
			</div>
			<div id="tabbar" class="weui-tabbar" style="display: none;">
				<a href="https://jsypay.jiaobaowang.net/wxth/appschweb/app/index.aspx" class="weui-tabbar__item">
					<div class="weui-tabbar__icon">
						<img class="img" src="../../../image/utils/wxhome.png">
					</div>
					<p class="weui-tabbar__label">微校园</p>
				</a>
				<a href="addleaveapply.html" class="weui-tabbar__item  weui-bar__item--on">
					<div class="weui-tabbar__icon">
						<img class="img" src="../../../image/leave/applyactive.png">
					</div>
					<p class="weui-tabbar__label">请假申请</p>
				</a>
				<a href="mineleavelist.html" class="weui-tabbar__item">
					<div class="weui-tabbar__icon">
						<img src="../../../image/leave/applyquery.png">
					</div>
					<p class="weui-tabbar__label">请假查询</p>
				</a>
				<a id="checkItem" href="leave-check.html" class="weui-tabbar__item" style="display: none;">
					<div class="weui-tabbar__icon">
						<img src="../../../image/leave/checkquery.png">
					</div>
					<p class="weui-tabbar__label">请假审核</p>
				</a>
			</div>
		</div>
		<input id="qnInput" style="display: none;" />
		<!--查看图片-->
		<div id="gallery" class="weui-gallery">
			<span id="galleryImage" class="weui-gallery__img"></span>
			<div class="weui-gallery__opr">
				<a class="weui-gallery__del">
					<i class="weui-icon-delete weui-icon_gallery-delete"></i>
				</a>
			</div>
		</div>
		<script type="text/javascript" src="../../../js/lib/vconsole/vconsole.min.js"></script>
		<script type="text/javascript" src="../../../js/demoCssJs/jquery-2.1.4.js"></script>
		<script type="text/javascript" src="../../../js/demoCssJs/jquery-weui.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/plupload/moxie.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/plupload/plupload.full.min.js"></script>
		<script type="text/javascript" src="../../../js/lib/qiniu/qiniu.min.js"></script>
		<script type="text/javascript" src="../../../js/utils/cryption.js"></script>
		<script type="text/javascript" src="../../../js/lib/exif/exif.min.js"></script>
		<script type="text/javascript">
			document.write("<s" + "cript type='text/javascript' src='../../../js/PublicProtocol.js" + WebVersion + "'></s" + "cript>");
			document.write("<s" + "cript type='text/javascript' src='../../../js/utils/utils.js" + WebVersion + "'></s" + "cript>");
			document.write("<s" + "cript type='text/javascript' src='../../../js/utils/storageutil.js" + WebVersion + "'></s" + "cript>");
			document.write("<s" + "cript type='text/javascript' src='../../../js/utils/cloudutil.js" + WebVersion + "'></s" + "cript>");
			document.write("<s" + "cript type='text/javascript' src='../../../js/utils/compress.js" + WebVersion + "'></s" + "cript>");
			document.write("<s" + "cript type='text/javascript' src='../../../js/utils/request.js" + WebVersion + "'></s" + "cript>");
			//document.write("<s" + "cript type='text/javascript' src='../../../temp/mineinfo.js" + WebVersion + "'></s" + "cript>");
		</script>
		<script type="text/javascript">
			var qnUploader; //七牛上传控件
			var uptokenData; //七牛上传凭证
			var tempString; //处理图片失败的提示
			var uploadFile = []; //上传图片的数组
			var showImageIndex; //当前显示的图片的序号
			var uploadImageIndex; //当前上传的图片的序号
			var liUpload; //上传图片对应的li元素
			var uploadError; //本次上传是否出错
			var mineUserInfo; //我的个人信息
			var beginTime = ""; //请假开始时间
			var endTime = ""; //请假结束时间
			var webType = "提交";
			var procTypeData = {
				key: [],
				select: [],
				value: {}
			} //流程类型
			var leaveTypeData = {
				key: [],
				select: [],
				value: {}
			} //请假类型

			var changeData; //修改请假申请的数据
			var procTypeSelectIndex; //流程类型选项初始化时的序号
			var leaveTypeSelectIndex; //请假类型选项初始化时的序号
			window.onload = function() {
				$.showLoading();
				initData();
			}

			function initData() {
				//判断是否是修改
				var search = location.search.toString();
				var keyword = "?change=";
				var index = search.indexOf(keyword);
				var isChange = false; //是否是修改请假申请
				if(index != -1) {
					isChange = true;
					var sKey = search.substring(index + keyword.length);
					var sValue = storageutil.getSessionStorage(sKey);
					if(sValue) {
						var obj = JSON.parse(sValue)
						changeData = obj.leave;
						mineUserInfo = obj.mineUserInfo;
					}
				}
				console.log("isChange:" + isChange);
				console.log("changeData", changeData);
				console.log("mineUserInfo", mineUserInfo);
				if(isChange) { //进入修改页面
					$("#submitForm").text("修改请假申请");
					webType = "修改";
					if(changeData) {
						getProcType();
					} else {
						$.hideLoading();
						$.alert("未获取到有效的初始数据，无法修改请假申请", "提示");
					}
				} else {
					$("#tabbar").css("display", "flex");
					getMineInfo();
				}
				$("#submitForm").css("display", "block");
			}

			/**
			 * 初始化
			 */
			function initPage() {
				console.log("允许" + webType + "请假申请");
				initSelect();
				if(changeData) { //修改请假申请
					$("#represon").val(changeData.ApplyReason);
					initDatePicker(changeData.ApplyBeginTime, changeData.ApplyEndTime);
					changeData.ApplyBeginTime = changeData.ApplyBeginTime.replace(/-|:|\s/g, "");
					changeData.ApplyEndTime = changeData.ApplyEndTime.replace(/-|:|\s/g, "");
					beginTime = changeData.ApplyBeginTime;
					endTime = changeData.ApplyEndTime;
					initPic();
				} else {
					initDatePicker();
				}
				initListener();
				initUploader();
				$("#submitForm").removeClass("weui-btn_disabled");
				$("#submitForm").click(clickSubmitForm);
			}

			/**
			 * 初始化流程类型和请假类型控件
			 */
			function initSelect() {
				var procType = procTypeData.select[procTypeSelectIndex];
				if(procType) {
					$("#selectTypeFirstInput").attr("value", procType.title);
					$("#selectTypeFirstInput").attr("data-values", procType.value);
				}
				$("#selectTypeFirstInput").select({
					title: "流程类型",
					closeText: "关闭",
					items: procTypeData.select,
				});
				var leaveType = leaveTypeData.select[leaveTypeSelectIndex];
				if(leaveType) {
					$("#selectTypeSecondInput").attr("value", leaveType.title);
					$("#selectTypeSecondInput").attr("data-values", leaveType.value);
				}
				$("#selectTypeSecondInput").select({
					title: "请假类型",
					closeText: "关闭",
					items: leaveTypeData.select,
				});
			}

			/**
			 * 初始化开始，结束时间选择控件
			 * @param {String} begin "2017-12-04 17:22"
			 * @param {String} end "2017-12-04 17:22"
			 */
			function initDatePicker(begin, end) {
				$("#selectTypeThirdInput").datetimePicker({
					title: "开始时间",
					toolbarCloseText: "关闭",
					onChange: function(data) {
						beginTime = data.value.join("");
					},
					value: begin
				});
				$("#selectTypeFourthInput").datetimePicker({
					title: "结束时间",
					toolbarCloseText: "关闭",
					onChange: function(data) {
						endTime = data.value.join("");
					},
					value: end
				});
			}

			/**
			 * 修改请假申请时初始化图片
			 */
			function initPic() {
				if(changeData.ApplyPic != "") {
					var pic = changeData.ApplyPic.split("|");
					var picThumb = changeData.ApplyReasonThumb.split("|");
					for(var i = 0; i < pic.length; i++) {
						var temp = {
							success: 1,
							allowUpload: false,
							filePath: pic[i],
							saveurl: pic[i],
							imgurl: picThumb[i]
						}
						$("#uploaderFiles").append('<li class="weui-uploader__file weui-uploader__file_status" style="background-image:url(' + pic[i] + ')"><div class="weui-uploader__file-content"><i class="weui-icon-success"></i></div></li>');
						uploadFile.push(temp);
					}
					$("#imageAmount").text(uploadFile.length + "/9");
					if(uploadFile.length == 9) {
						$(".weui-uploader__input-box").css("display", "none");
					}
				}
			}

			/**
			 * 初始化监听
			 */
			function initListener() {
				//添加图片
				$("#addImage").change(function(e) {
					console.log("fileChange:files", e.target.files);
					disposeAllFiles(e.target.files);
				});

				//查看图片
				$("#uploaderFiles").on("click", ".weui-uploader__file", function(e) {
					showImageIndex = $("#uploaderFiles .weui-uploader__file").index(this);
					$("#galleryImage").css("background-image", "url(" + uploadFile[showImageIndex].filePath + ")");
					$("#gallery").css("display", "block");
				});

				//隐藏查看图片
				$("#galleryImage").click(function() {
					$("#gallery").css("display", "none");
					$("#galleryImage").css("background-image", "");
					showImageIndex = null;
				});

				//删除图片
				$(".weui-gallery__del").click(function() {
					$.modal({
						title: "提示",
						text: "确定删除?",
						buttons: [{
							text: "取消",
							className: "default",
						}, {
							text: "确定",
							className: "color-danger",
							onClick: function() {
								var imageNumber = uploadFile.length - 1;
								$("#uploaderFiles").find(".weui-uploader__file")[showImageIndex].remove();
								$("#imageAmount").text(imageNumber + "/9");
								if(imageNumber < 9) {
									$(".weui-uploader__input-box").css("display", "block");
								}
								$("#gallery").css("display", "none");
								$("#galleryImage").css("background-image", "");
								uploadFile.splice(showImageIndex, 1);
								showImageIndex = null;
							}
						}]
					});
				});
			}

			/**
			 * 提交请假申请
			 */
			function clickSubmitForm() {
				var procTypeId = $("#selectTypeFirstInput").attr("data-values");
				if(!procTypeId) {
					$.alert("请选取流程类型");
					return false;
				}
				var leaveTypeId = $("#selectTypeSecondInput").attr("data-values");
				if(!leaveTypeId) {
					$.alert("请选取请假类型");
					return false;
				}
				if(!beginTime) {
					$.alert("请选取请假开始时间");
					return false;
				}
				if(!endTime) {
					$.alert("请选取请假结束时间");
					return false;
				}
				var represon = $.trim($("#represon").val()); //请假事由
				if(represon == "") {
					$.alert("请输入请假事由");
					return false;
				}
				$.showLoading();
				if(uploadFile.length == 0) {
					submitLeaveForm();
				} else {
					//重置失败的文件允许上传
					for(var i = 0; i < uploadFile.length; i++) {
						if(!uploadFile[i].success) {
							uploadFile[i].allowUpload = true;
						}
					}
					upLoadImages();
				}
			}

			/**
			 * 初始化七牛上传控件
			 */
			function initUploader() {
				var qnOption = cloudutil.getQiNiuInitOption("qnInput");
				qnOption.flash_swf_url = "../../../js/lib/plupload/Moxie.swf";
				qnOption.auto_start = true;
				qnOption.uptoken_func = function(file) {
					// 在需要获取 uptoken 时，该方法会被调用
					var getTokenData = {
						appId: storageutil.QNQYWXKID,
						mainSpace: storageutil.QNPUBSPACE,
						saveSpace: storageutil.QNLEAVE,
						qnCmdOption: {
							type: 2
						},
						fileArray: [{
							qnFileName: cloudutil.getQNName(file.name),
						}]
					}
					uptokenData = null;
					cloudutil.getFileUpTokens(getTokenData, function(data) {
						uptokenData = data;
					});
					console.log("uptokenData", uptokenData);
					if(uptokenData && uptokenData.code) { //成功
						console.log("fileUrl:" + uptokenData.data.Data[0].Domain + uptokenData.data.Data[0].Key);
						console.log("cropUrl:" + uptokenData.data.Data[0].OtherKey[uptokenData.thumbKey[0]]);
						return uptokenData.data.Data[0].Token;
					} else {
						qnUploader.stop();
						uploadError = true;
						uploadImageError("获取上传凭证失败");
					}
				}
				qnOption.init = {
					'FilesAdded': function(up, files) {
						plupload.each(files, function(file) {
							// 文件添加进队列后,处理相关的事情
							console.log("FilesAdded:", file);
						});
					},
					'UploadProgress': function(up, file) {
						// 每个文件上传时,处理相关的事情
						console.log("UploadProgress:" + file.percent);
						if(liUpload) {
							liUpload.innerHTML = '<div class="weui-uploader__file-content">' + file.percent + '%</div>';
						}
					},
					'FileUploaded': function(up, file, info) {
						// 每个文件上传结束后,处理相关的事情
						console.log("FileUploaded:up", up);
						console.log("FileUploaded:info", info);
						if(info.status == 200) {
							//成功
							console.log("上传成功");
							liUpload.innerHTML = '<div class="weui-uploader__file-content"><i class="weui-icon-success"></i></div>';
							uploadFile[uploadImageIndex].success = true;
							uploadFile[uploadImageIndex].newname = uptokenData.data.Data[0].Key;
							uploadFile[uploadImageIndex].saveurl = uptokenData.data.Data[0].Domain + uptokenData.data.Data[0].Key;
							uploadFile[uploadImageIndex].imgurl = uptokenData.data.Data[0].OtherKey[uptokenData.thumbKey[0]];
						} else {
							uploadImageError(info.response);
						}
						upLoadImages();
					},
					'Error': function(up, err, errTip) {
						//上传出错时,处理相关的事情
						console.log("Error:", err, errTip);
						uploadImageError(errTip);
					},
					'FilesRemoved ': function() {
						//文件移出队列
						console.log("FilesRemoved:文件移出队列");
						if(uploadError) {
							uploadError = false;
							upLoadImages();
						}
					},
					'Key': function(up, file) {
						// 若想在前端对每个文件的key进行个性化处理，可以配置该函数
						// 该配置必须要在 unique_names: false , save_key: false 时才生效
						if(uptokenData && uptokenData.code) { //成功
							return uptokenData.data.Data[0].Key;
						}
					}
				}
				qnUploader = Qiniu.uploader(qnOption);
			}

			/**
			 * 处理选取的图片
			 * @param {Array} files 文件数组
			 */
			function disposeAllFiles(files) {
				if(files.length == 1 && (files[0].size == 0 || files[0].name == "/")) {
					//处理安卓不选取图片的情况
					console.log("未选择图片");
					return false;
				}
				$.showLoading();
				disposeFile(files, 0);
			}

			/**
			 * 处理单个文件
			 * @param {Array} files 文件数组
			 * @param {Number} num 文件序号
			 */
			function disposeFile(files, num) {
				console.log("disposeFile:" + num);
				var types = files[num].type.toLowerCase().split("/");
				if(types[0] == "image") {
					EXIF.getData(files[num], function() {
						var orientation = EXIF.getTag(this, 'Orientation'); //获取旋转信息
						//显示文件
						var reader = new FileReader();
						reader.onload = function() {
							var result = this.result;
							var maxSize = 2 * 1024 * 1024;
							compress.getImgInfo(result, function(img, imgInfo) {
								var newDataUrl = compress.getCanvasDataUrl(img, compress.getSuitableSize(imgInfo, Math.ceil(result.length / maxSize)), orientation);
								var newImage = {
									filePath: newDataUrl, //文件路径
									allowUpload: true, //是否允许上传
									oldname: files[num].name //原始文件名
								}
								//界面中添加图片
								$("#uploaderFiles").append('<li class="weui-uploader__file" style="background-image:url(' + newDataUrl + ')"></li>');
								uploadFile.push(newImage);
								$("#imageAmount").text(uploadFile.length + "/9");
								disposeFileNextFile(files, num);
							});
						}
						reader.readAsDataURL(files[num]);
					});
				} else {
					tempString = "请选取图片类型的文件";
					disposeFileNextFile(files, num);
				}
			}

			/**
			 * 处理下一个文件的逻辑判断
			 * @param {Object} files
			 * @param {Object} num
			 */
			function disposeFileNextFile(files, num) {
				var finish = false;
				if(num == files.length - 1) {
					//所有文件已经处理完
					finish = true;
				} else {
					if(uploadFile.length == 9) {
						finish = true;
						tempString = "最多只能上传9张照片";
					}
				}
				if(finish) {
					$('#addImage').val('');
					if(tempString) {
						$.alert(tempString, "选择失败");
					}
					tempString = null;
					if(uploadFile.length == 9) {
						$(".weui-uploader__input-box").css("display", "none");
					}
					$.hideLoading();
					console.log("处理完成", uploadFile);
				} else {
					num++;
					disposeFile(files, num);
				}
			}

			/**
			 * 上传图片
			 */
			function upLoadImages() {
				var finish = true; //是否已经结束上传
				var allSuccessUpload = true; //是否所有的文件都成功上传
				for(var i = 0; i < uploadFile.length; i++) {
					if(!uploadFile[i].success) {
						//有未成功的文件
						allSuccessUpload = false;
					}
					if(uploadFile[i].allowUpload) {
						//允许上传
						console.log("uploadImageIndex:" + i);
						uploadImageIndex = i;
						finish = false;
						break;
					}
				}
				if(finish) {
					if(allSuccessUpload) {
						console.log("结束后所有的文件都成功上传");
						submitLeaveForm();
					} else {
						console.log("结束后有文件未成功上传");
						if(tempString) {
							$.alert(tempString, "上传失败");
						}
						tempString = null;
						$.hideLoading();
					}
				} else {
					uploadFile[uploadImageIndex].allowUpload = false; //文件本次循环上传，已上传过
					var blob = compress.base64ToBlob(uploadFile[uploadImageIndex].filePath, 'image/jpeg');
					blob.lastModifiedDate = new Date();
					var fileName = blob.lastModifiedDate.getTime() + ".jpg";
					console.log('blob', blob);
					uploadFile[uploadImageIndex].filesize = blob.size;
					liUpload = $("#uploaderFiles").find(".weui-uploader__file")[uploadImageIndex];
					liUpload.className = "weui-uploader__file weui-uploader__file_status";
					liUpload.innerHTML = '<div class="weui-uploader__file-content"><i class="weui-icon-waiting"></i></div>';
					qnUploader.addFile(blob, fileName);
				}
			}

			/**
			 * 上传图片失败
			 */
			function uploadImageError(errTip) {
				console.log("上传失败");
				liUpload.innerHTML = '<div class="weui-uploader__file-content"><i class="weui-icon-warn"></i></div>';
				tempString = errTip;
				uploadError = true;
				qnUploader.splice(0, 1); //移除当前队列文件
			}

			/**
			 * 提交请假的表单
			 */
			function submitLeaveForm() {
				var submitForm = {
					procTypeId: $("#selectTypeFirstInput").attr("data-values"),
					leaveTypeId: $("#selectTypeSecondInput").attr("data-values"),
					beginTime: beginTime,
					endTime: endTime,
					applyReason: $.trim($("#represon").val()),
					applyPic: "",
					applyPicThumb: ""
				}
				if(uploadFile.length != 0) {
					var pic = [];
					var picThumb = [];
					for(var i = 0; i < uploadFile.length; i++) {
						pic.push(uploadFile[i].saveurl);
						picThumb.push(uploadFile[i].imgurl);
					}
					submitForm.applyPic = pic.join("|");
					submitForm.applyPicThumb = picThumb.join("|");
				}
				if(webType == "提交") {
					submitForm.corpId = mineUserInfo.corpid;
					submitForm.deptId = mineUserInfo.department[0];
					submitForm.applyMan = mineUserInfo.userid;
					submitForm.applyManName = mineUserInfo.name;
					submitForm.applyManPic = mineUserInfo.avatar;
					console.log("submitForm", submitForm);
					addLeaveApply(submitForm);
				} else {
					if(submitForm.procTypeId == changeData.ProcessTypeId && submitForm.leaveTypeId == changeData.LeaveTypeId) {
						if(submitForm.beginTime == changeData.ApplyBeginTime && submitForm.endTime == changeData.ApplyEndTime) {
							if(submitForm.applyReason == changeData.ApplyReason && submitForm.applyPic == changeData.ApplyPic) {
								$.hideLoading();
								$.alert("未做任何修改", "提示");
								return false;
							}
						}

					}
					submitForm.leaveApplyId = changeData.ApplyId;
					console.log("submitForm", submitForm);
					changeLeaveApply(submitForm);
				}
			}

			/**
			 * 添加一个请假申请
			 * @param {Object} submitForm
			 */
			function addLeaveApply(submitForm) {
				processRequest.postProcessData("addLeaveApply", submitForm, function(data) {
					$.hideLoading();
					if(data.RspCode == 0) {
						$.toast("提交成功");
						$("#selectTypeFirstInput").attr("value", "");
						$("#selectTypeFirstInput").attr("data-values", "");
						$("#selectTypeSecondInput").attr("value", "");
						$("#selectTypeSecondInput").attr("data-values", "");
						$("#selectTypeThirdInput").removeAttr("readonly");
						$("#selectTypeFourthInput").removeAttr("readonly");
						$("#selectTypeThirdInput").val("");
						$("#selectTypeFourthInput").val("");
						$("#selectTypeThirdInput").attr("readonly", "readonly");
						$("#selectTypeFourthInput").attr("readonly", "readonly");
						beginTime = "";
						endTime = "";
						$("#represon").val("");
						$("#imageAmount").text("0/9");
						uploadFile = null;
						uploadFile = [];
						$("#uploaderFiles").empty();
					} else {
						$.alert("提交失败(" + data.RspTxt + ")", "提示");
					}
				});
			}

			/**
			 * 修改请假申请
			 * @param {Object} submitForm
			 */
			function changeLeaveApply(submitForm) {
				processRequest.postProcessData("setLeaveApply", submitForm, function(data) {
					$.hideLoading();
					if(data.RspCode == 0 && data.RspData.Result == 1) {
						$.toast("修改成功");
						changeData.ProcessTypeId = submitForm.procTypeId;
						changeData.LeaveTypeId = submitForm.leaveTypeId;
						changeData.ApplyBeginTime = submitForm.beginTime;
						changeData.ApplyEndTime = submitForm.endTime;
						changeData.ApplyReason = submitForm.applyReason;
						changeData.ApplyPic = submitForm.applyPic;
						changeData.ApplyReasonThumb = submitForm.applyPicThumb;
					} else {
						$.alert("修改失败(" + data.RspTxt + ")", "提示");
					}
				});
			}

			/**
			 * 获取流程类型
			 */
			function getProcType() {
				var tempData = {
					corpId: mineUserInfo.corpid,
//					stat: 1,
					pageIndex: 1,
					pageSize: 0
				}
				processRequest.postProcessData("getProcessTypeForSel", tempData, function(data) {
					if(data.RspCode == 0 && data.RspData.Data.length != 0) {
						for(var i = 0; i < data.RspData.Data.length; i++) {
							procTypeData.key.push(data.RspData.Data[i].ProcessTypeId);
							procTypeData.value[data.RspData.Data[i].ProcessTypeId] = data.RspData.Data[i];
							if(changeData && changeData.ProcessTypeId == data.RspData.Data[i].ProcessTypeId) {
								procTypeSelectIndex = procTypeData.select.length;
							}
							if(data.RspData.Data[i].Stat == 1) {
								procTypeData.select.push({
									title: data.RspData.Data[i].ProcTypeName,
									value: data.RspData.Data[i].ProcessTypeId
								});
							}
						}
					}
					if(procTypeData.select.length == 0) {
						var errStr = "";
						if(data.RspCode != 0) {
							errStr = "(" + data.RspTxt + ")";
						}
						$.hideLoading();
						$.alert("未获取到有效的流程类型，无法" + webType + "请假申请" + errStr + "", "提示");
					} else {
						getLeaveType();
					}
				});
			}
			/**
			 * 获取请假类型
			 */
			function getLeaveType() {
				var tempData = {
					corpId: mineUserInfo.corpid,
					stat: 1,
					pageIndex: 1,
					pageSize: 0
				}
				processRequest.postProcessData("getLeaveType", tempData, function(data) {
					if(data.RspCode == 0 && data.RspData.Data.length != 0) {
						for(var i = 0; i < data.RspData.Data.length; i++) {
							leaveTypeData.key.push(data.RspData.Data[i].LeaveTypeId);
							leaveTypeData.value[data.RspData.Data[i].LeaveTypeId] = data.RspData.Data[i];
							if(data.RspData.Data[i].IsLeader == 0 || (data.RspData.Data[i].IsLeader == 1 && mineUserInfo.isleader == 1) || (data.RspData.Data[i].IsLeader == 2 && mineUserInfo.isleader == 0)) { //请假类型为全部
								//请假类型为全部||(请假类型为老师&&个人身份为上级)||(请假类型为家长&&个人身份不是上级)
								if(changeData && changeData.LeaveTypeId == data.RspData.Data[i].LeaveTypeId) {
									leaveTypeSelectIndex = leaveTypeData.select.length;
								}
								if(data.RspData.Data[i].Stat == 1) {
									leaveTypeData.select.push({
										title: data.RspData.Data[i].LeaveTypeName,
										value: data.RspData.Data[i].LeaveTypeId
									});
								}
							}
						}
					}
					if(leaveTypeData.select.length == 0) {
						var errStr = "";
						if(data.RspCode != 0) {
							errStr = "(" + data.RspTxt + ")";
						}
						$.hideLoading();
						$.alert("未获取到有效的请假类型，无法" + webType + "请假申请" + errStr + "", "提示");
					} else {
						initPage();
						$.hideLoading();
					}
				});
			}

			/**
			 * 获取我的信息
			 */
			function getMineInfo() {
				var tempData = {
					cmd: 'userinfo',
					type: 'findpage',
					colv: ""
				}
				unitWebsitePro(tempData, function(data) {
					//data = getMineInfoCallBack;
					if(data.RspCode == 0) {
						mineUserInfo = JSON.parse(data.RspData);
						checkPower();
						getProcType();
					} else {
						$.hideLoading();
						$.alert("未获取到有效的个人信息，无法提交请假申请(" + data.RspTxt + ")", "提示");
					}
				});
			}

			/**
			 * 检查是否有审核权限
			 */
			function checkPower() {
				var tempData = {
					corpId: mineUserInfo.corpid,
					userId: mineUserInfo.userid,
				}
				processRequest.postProcessData("getApprPowerByUser ", tempData, function(data) {
					if(data.RspCode == 0 && data.RspData.Result != 0) {
						$("#checkItem").css("display", "block")
					}
				});
			}
		</script>
	</body>

</html>