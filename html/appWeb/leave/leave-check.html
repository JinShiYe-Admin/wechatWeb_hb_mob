<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../../css/weui.min.css" rel="stylesheet" />
		<link href="../../../css/jquery-weui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../../js/demoCssJs/demos.css" />
		<title>维修状况</title>
		<style type="text/css">
			body {
				-webkit-overflow-scrolling: touch;
			}
			
			.weui-tab__bd .weui-tab__bd-item {
				width: 100%;
			}
			
			.weui-cell {
				display: block;
			}
			
			.head-portrait {
				width: 80%;
				border-radius: 50%;
			}
			
			.head-container {
				width: 15%;
				text-align: center;
			}
			
			.item-hint,
			.apply-date {
				color: darkgrey;
			}
			
			.item-hint,
			.apply-date,
			.item-info {
				font-size: 0.8em;
			}
			
			.weui-pull-to-refresh__layer {
				padding: 0;
			}
			
			.weui-loadmore {
				margin-bottom: 71px;
			}
		</style>
	</head>

	<body ontouchstart>
		<div class="weui-tab" id="tabs">
			<div class="weui-navbar">
				<div v-for="tab in tabs" class="weui-navbar__item" v-bind:class="[{'weui-bar__item--on':tab.apprStat===activeIndex}]" v-bind:href="'#tab'+tab.apprStat" v-on:click="setactiveIndex(tab.apprStat)">{{tab.title}}</div>
			</div>
			<div class="weui-tab__bd">
				<div v-for="tab in tabs" :id="'tab'+tab.apprStat" class="weui-tab__bd-item  weui-pull-to-refresh infinite" :class="[{'weui-tab__bd-item--active':tab.apprStat===activeIndex}]">
					<div class="weui-pull-to-refresh__layer">
						<div class='weui-pull-to-refresh__arrow'></div>
						<div class='weui-pull-to-refresh__preloader'></div>
						<div class="down">下拉刷新</div>
						<div class="up">释放刷新</div>
						<div class="refresh">正在刷新</div>
					</div>
					<div class="weui-cells">
						<div v-for="item in tab.list" class="weui-cell" v-on:click="jumpToDetail(item)">
							<div class="weui-flex">
								<div class="head-container"><img class="head-portrait" src="https://github.com/rockan007/photos/blob/master/bug.png?raw=true" /></div>
								<div class="weui-flex__item">
									<p><span class="item-hint">姓名:</span><span class="item-info">{{item.ApplyManName}}</span></p>
									<p><span class="item-hint">请假类型:</span><span class="item-info">{{item.LeaveTypeName}}</span></p>
									<p><span class="item-hint">开始时间:</span><span class="item-info">{{item.ApplyBeginTime}}</span></p>
									<p><span class="item-hint">结束时间:</span><span class="item-info">{{item.ApplyEndTime}}</span></p>
								</div>
								<div>
									<p class="apply-date">{{item.ApplyTime}}</p>
								</div>
							</div>
						</div>
					</div>
					<div v-show="tab.haveMore" class="weui-loadmore">
						<i class="weui-loading"></i>
						<span class="weui-loadmore__tips">正在加载</span>
					</div>
				</div>
			</div>
			<div class="weui-tabbar">
				<a href="https://jsypay.jiaobaowang.net/wxth/appschweb/app/index.aspx" class="weui-tabbar__item">
					<div class="weui-tabbar__icon">
						<img class="img" src="../../../image/utils/wxhome.png">
					</div>
					<p class="weui-tabbar__label">微校园</p>
				</a>
				<a href="addleaveapply.html" class="weui-tabbar__item">
					<div class="weui-tabbar__icon">
						<img class="img" src="../../../image/leave/apply.png">
					</div>
					<p class="weui-tabbar__label">请假申请</p>
				</a>
				<a href="mineleavelist.html" class="weui-tabbar__item ">
					<div class="weui-tabbar__icon">
						<img src="../../../image/leave/applyquery.png">
					</div>
					<p class="weui-tabbar__label">请假查询</p>
				</a>
				<a id="checkItem" href="leave-check.html" class="weui-tabbar__item weui-bar__item--on">
					<div class="weui-tabbar__icon">
						<img src="../../../image/leave/checkqueryactive.png">
					</div>
					<p class="weui-tabbar__label">请假审核</p>
				</a>
			</div>
		</div>

		<script src="../../../js/jquery.min.js"></script>
		<script src="../../../js/jquery-weui.min.js"></script>
		<script src="../../../js/vue.js"></script>
		<script src="../../../js/vue-router.js"></script>
		<script src="../../../js/utils/consts.js"></script>
		<script src="../../../js/utils/request.js"></script>
		<script>
			var list = new Vue({
				el: "#tabs",
				data: {
					activeIndex: 0,
					tabs: [{
						apprStat: 0,
						title: "全部",
						haveMore: false,
						pageIndex: 1,
						totalPage: 0,
						list: []
					}, {
						apprStat: 1,
						title: "未审批",
						haveMore: false,
						pageIndex: 1,
						totalPage: 0,
						list: []
					}, {
						apprStat: 2,
						title: "已通过",
						haveMore: false,
						pageIndex: 1,
						totalPage: 0,
						list: []
					}, {
						apprStat: 3,
						title: "驳回",
						haveMore: false,
						pageIndex: 1,
						totalPage: 0,
						list: []
					}]
				},
				mounted: function() {
					console.log("*****mounted*****");
					this.initialData();
					this.initialLoad();
				},
				methods: {
					/**
					 * 初始化界面
					 */
					initialData: function() {
						console.log("****initialData******")
						this.getCorpId(this.requestList);
						this.tabs[this.activeIndex].haveMore = true
					},
					initialLoad: function() {
						console.log("*****initialLoad*****");
						var com = this;
						$('.weui-tab__bd-item').pullToRefresh().on('pull-to-refresh', function(done) {
							var self = this
							setTimeout(function() {
								com.tabs[com.activeIndex].list = []
								//								com.initialData();
								$(self).pullToRefreshDone();
							}, 2000)
						});
						$('.infinite').infinite().on("infinite", function() {
							var self = this;
							console.log(self.loading)
							if(self.loading) return;
							self.loading = true;
							console.log(self);
							setTimeout(function() {
								com.loadMore();
								self.loading = false;
							}, 2000); //模拟延迟
						});
					},
					/**
					 * 获取单位Id
					 */
					getCorpId: function(callback) {
						var com = this;
						request.requestPersonalInfo(function(response) {
							console.log("获取的corpId数据：" + JSON.stringify(response));
							if(response.RspCode == 0) {
								com.corpId = JSON.parse(response.RspData).corpid;
								callback();
							}
						})
					},
					/**
					 * 设置活动的id
					 * @param {Object} id
					 */
					setactiveIndex: function(id) {
						this.activeIndex = id;
					},
					/**
					 * 请求数据
					 */
					requestList: function() {
						console.log("****reauestList获取审核列表****")
						var com = this;
						processRequest.postProcessData("getProcessApprove", {
							corpId: com.corpId,
							apprMan: com.selfId,
							apprStat: com.activeIndex,
							pageIndex: com.tabs[com.activeIndex].pageIndex,
							pageSize: 10
						}, function(response) {
							console.log("获取的审核列表数据：" + JSON.stringify(response))
							if(response.RspCode == 0) {
								com.setData(response.RspData);
							} else {
								
							}
						})
					},
					/**
					 * 设置数据
					 * @param {Object} data
					 */
					setData: function(data) {
						console.log("****setData******");
						var activeTab = this.tabs[this.activeIndex];
						if(activeTab.pageIndex === 1) {
							activeTab.list = data;
						} else {
							activeTab.list = activeTab.list.concat(data);
						}
					},
					/**
					 * 刷新列表
					 */
					refreshList: function() {
						console.log("*****refreshList******");
						this.tabs[this.activeIndex].pageIndex = 1;
						this.requestList();
					},
					loadMore: function() {
						console.log("*****loadMore******");
						this.tabs[this.activeIndex].pageIndex++;
						this.requestList();
					},
					jumpToDetail: function(item) {
						console.log("******jumpToDetail*******");
						var sKey = new Date().getTime() + "" + parseInt(Math.random() * 1000);
						var sValue = {
							leave: item,
							mineUserInfo: ""
						}
						storageutil.setSessionStorage(sKey, JSON.stringify(sValue));
						location.href = "leave-detail.html?flag=1&sKey=" + sKey;
					}
				}
			})
		</script>
	</body>

</html>