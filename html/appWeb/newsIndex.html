<!DOCTYPE html>
<html>

	<head>
		<title>jQuery WeUI</title>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.">
		<link rel="stylesheet" href="../../js/demoCssJs/weui.min.css">
		<link rel="stylesheet" href="../../js/demoCssJs/jquery-weui.css">
		<link rel="stylesheet" href="../../js/demoCssJs/demos.css">
		<style>
			.has-max {
				max-width: 640px;
			}
			
			.category_nav {
				white-space: nowrap;
				display: inline-block;
			}
			
			.category_nav a {
				display: inline-block;
				position: relative;
			}
			
			.category_nav li a {
				display: inline-block;
				padding: 0 .5rem;
			}
			
			.wrap {
				width: 30px;
				position: relative;
			}
			
			.img {
				width: 27px;
				height: 27px;
			}
			
			.notice {
				width: 15px;
				height: 15px;
				line-height: 15px;
				font-size: 10px;
				color: #fff;
				text-align: center;
				background-color: #f00;
				border-radius: 50%;
				position: absolute;
				right: -7px;
				top: -7px;
			}
		</style>
	</head>

	<body ontouchstart>
		<div class="weui-tab" id="wrapper">
			<div class="weui-navbar category_nav">
				<a class="weui-navbar__item" :class="{'weui-bar__item--on':item.active}" v-for="item in items" :href="'#tab'+item.chnid">{{item.cname}}</a>
			</div>
			<div class="weui-tab__bd">
				<div :id="'tab'+item.chnid" class="weui-tab__bd-item infinite  weui-pull-to-refresh" :class="{'weui-tab__bd-item--active':item.active}" v-for="item in items" style="width: 100%;">
					<div class="weui-pull-to-refresh__layer">
						<div class='weui-pull-to-refresh__arrow'></div>
						<div class='weui-pull-to-refresh__preloader'></div>
						<div class="down">下拉刷新</div>
						<div class="up">释放刷新</div>
						<div class="refresh">正在刷新</div>
					</div>

					<!--<div class="weui-cells">-->
					<a class="weui-cell weui-cell_access" href="javascript:;" v-for="newsModel in item.newsArray">
						<div class="weui-cell__hd"><img src="../../image/icon_tabbar.png" alt="" style="width:20px;margin-right:5px;display:block"></div>
						<div class="weui-cell__bd">
							<p>{{newsModel.topic}}</p>
						</div>
						<div class="weui-cell__ft">说明文字</div>
					</a>
					<div class="weui-loadmore">
						<i class="weui-loading"></i>
						<span class="weui-loadmore__tips">正在加载</span>
					</div>
					<!--</div>-->
				</div>
			</div>
			<div class="weui-tabbar">
				<a href="#" class="weui-tabbar__item weui-bar__item--on">

					<div class="wrap">
						<img class="img" src="./images/icon_nav_button.png" alt="">
						<div class="notice">8</div>
					</div>
					<p class="weui-tabbar__label">微信</p>

				</a>
				<a href="mineIndex.html" class="weui-tabbar__item">
					<div class="wrap">
						<img class="img" src="./images/icon_nav_msg.png" alt="">
						<div class="notice">12</div>
					</div>
					<p class="weui-tabbar__label">我的</p>
				</a>
			</div>
		</div>
		<script src="../../js/demoCssJs/jquery-2.1.4.js"></script>
		<script src="../../js/demoCssJs/iscroll.js"></script>
		<script src="../../js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/demoCssJs/jquery-weui.js"></script>
		<script type="text/javascript">
			document.write("<s" + "cript type='text/javascript' src='../../js/importJS.js?" + Math.random() + "'></s" + "cript>");
		</script>
		<script>
			var columnData = new Vue({
				el: '#wrapper',
				data: {
					items: [{}] //列表信息流数据
				},
				methods: {
					clickCulumn: function(model) {
						alert('model:' + JSON.stringify(model));
					}
				}
			});
			var newsFlag = 0;//获取当前界面栏目新闻的索引

			//var myScroll = new IScroll('#wrapper');
			//每个选项栏的高度重新调整
			var allheight = document.getElementsByClassName('weui-tab')[0].scrollHeight
			var barheight = document.getElementsByClassName('weui-tabbar')[0].scrollHeight
			$('.weui-tab__bd').css({
				'height': (allheight - barheight) * 100 / allheight + '%'
			});
			$('.weui-tab__bd-item').css({
				'height': (allheight - barheight) * 100 / allheight + '%'
			});
			//有红点提示的宽度调整
			var tabar_width = document.getElementsByClassName('weui-tabbar__item')[0].scrollWidth
			$('.wrap').css({
				'left': (tabar_width - 30) * 50 / tabar_width + '%'
			});
			window.addEventListener("resize", function() {
				var allheight = document.getElementsByClassName('weui-tab')[0].scrollHeight
				var barheight = document.getElementsByClassName('weui-tabbar')[0].scrollHeight
				$('.weui-tab__bd').css({
					'height': (allheight - barheight) * 100 / allheight + '%'
				});
				$('.weui-tab__bd-item').css({
					'height': (allheight - barheight) * 100 / allheight + '%'
				});

				var tabar_width = document.getElementsByClassName('weui-tabbar__item')[0].scrollWidth
				$('.wrap').css({
					'left': (tabar_width - 30) * 50 / tabar_width + '%'
				});
			}, false);

			$(".infinite").infinite(0).on("infinite", function() {
				var self = this;
				newsFlag = self.getAttribute('id');
				if(self.loading) return;
				$(self).find(".weui-loadmore").show();
				console.log(self)
				self.loading = true;
				console.log(self);
				setTimeout(function() {
//					$(self).find(".content-padded").append("<p>我是加载的新内容。我是加载的新内容我是加载的新内容我是加载的新内容我是加载的新内容我是加载的新内容我是加载的新内容</p>");
					$(self).find(".weui-loadmore").hide();
					self.loading = false;
				}, 1000); //模拟延迟
			});
			$(".weui-loadmore").hide();
			$(".weui-pull-to-refresh").pullToRefresh().on("pull-to-refresh", function() {
				var self = this;
				newsFlag = self.getAttribute('id');
				if(self.loading) return;
				console.log(self)
				self.loading = true;
				console.log(self);
				setTimeout(function() {
//					$(self).find(".content-padded").append("<p>下拉刷新......下拉刷新......下拉刷新......下拉刷新......下拉刷新......下拉刷新......下拉刷新......</p>");
					self.loading = false;
					$(".weui-pull-to-refresh").pullToRefreshDone();
				}, 1000); //模拟延迟

			});
			//通过id，获取到当前的column，然后发送协议
			function selectColumnSendPro() {
				for (var item in columnData.items) {
					var tempModel = columnData.items[item];
					if (tempModel.chnid == newsFlag) {
						getNewsList(tempModel);
					}
				}
			}
			window.onload = function() {
				//获取所有的栏目
				getSumColumn();
				setTimeout(function() {
					var all_width = document.getElementsByClassName('category_nav')[0].scrollWidth
					$('.category_nav').css({
						'width': all_width + 'px'
					})
					var myscroll = new iScroll("wrapper", {
						scrollX: true,
						scrollY: false,
						hScrollbar: false,
						vScrollbar: true,
						vScroll: false
					});
				}, 1000); //模拟延迟
			};
			//获取所有的栏目
			function getSumColumn() {
				var tempData = {
					cmd: 'chn', //网站栏目
					type: 'findpage', //分页查找栏目列表
					pagesize: 999, //每页条数
					pageindex: 1 //页码
				}
				unitWebsitePro(tempData, function(data) {
					if(data.RspCode == 0) {
						
						if(data.RspData.dt.length > 0) {
							//塞入页码、加载状态等自定义参数
							for(var tempItem in data.RspData.dt) {
								data.RspData.dt[tempItem].newsPage = 1; //获取新闻的页码
								data.RspData.dt[tempItem].newsFlag = 0; //0刷新，1加载更多
								data.RspData.dt[tempItem].newsArray = []; //栏目对应的新闻列表
								if(tempItem == 0) {
									data.RspData.dt[tempItem].active = true;
								} else {
									data.RspData.dt[tempItem].active = false;
								}
							}
							columnData.items = data.RspData.dt;
							//获取索引为0的栏目新闻列表
							getNewsList(columnData.items[0]);
						} else {
							alert('暂时还没有栏目');
						}
					} else {
						alert(data.RspTxt);
					}
				});
			};
			//获取栏目对应的新闻
			function getNewsList(columnModel) {
				var tempData = {
					cmd: 'news', //文章管理
					type: 'findpage', //分页查找文章列表
					pagesize: '10', //每页条数
					pageindex: columnModel.newsPage, //页码
					chnid: columnModel.chnid //某个栏目下的文章，栏目id
				}
				unitWebsitePro(tempData, function(data) {
					if(data.RspCode == 0) {
						if(data.RspData.dt.length > 0) {
							//判断是刷新0，还是加载更多1
							if(columnModel.newsFlag == 0) {
								columnModel.newsArray = data.RspData.dt;
							} else {
								jQuery.merge(columnModel.newsArray, data.RspData.dt); //合并数组
							}
						}
						columnModel.newsPage++;
					} else {
						alert(data.RspTxt);
					}
				});
			}
		</script>
	</body>

</html>