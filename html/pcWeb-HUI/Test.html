<!DOCTYPE HTML>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="renderer" content="webkit|ie-comp|ie-stand">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
		<meta http-equiv="Cache-Control" content="no-siteapp" />

		<link rel="stylesheet" type="text/css" href="../../js/H-ui.admin/static/h-ui/css/H-ui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../js/H-ui.admin/static/h-ui.admin/css/H-ui.admin.css" />
		<link rel="stylesheet" type="text/css" href="../../js/H-ui.admin/lib/Hui-iconfont/1.0.8/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../js/H-ui.admin/static/h-ui.admin/css/skin.css" id="skin" />
		<link rel="stylesheet" type="text/css" href="../../js/H-ui.admin/static/h-ui.admin/css/style.css" />
		<style>
			.dropdown:after {
				content: '';
				position: absolute;
				z-index: 20;
				top: 18px;
				right: 10px;
				border: 4px dashed;
				border-color: #888888 transparent;
			}
			
			.dropdown:before {
				border-bottom-style: solid;
				border-top: none;
			}
			
			.dropdown:after {
				margin-top: 7px;
				border-top-style: solid;
				border-bottom: none;
			}
			
			.dropdown-select:focus {
				z-index: 6;
				width: 100%;
				color: #394349;
				outline: 10px solid #49aff2;
				outline: 2px solid -webkit-focus-ring-color;
				outline-offset: -2px;
			}
			
			.dropdown-select>option {
				margin: 10px;
				padding: 10px 50px;
				text-shadow: none;
				background: #FFFFFF;
				border-radius: 200px;
				cursor: pointer;
			}
			
			.lt-ie9 .dropdown {
				z-index: 1;
			}
			
			.lt-ie9 .dropdown-select {
				z-index: -1;
			}
			
			.lt-ie9 .dropdown-select:focus {
				z-index: 3;
			}
			
			@-moz-document url-prefix() {
				.dropdown-select {
					padding-left: 6px;
				}
			}
			
			.dropdown-dark {
				background: #444;
				border-color: #111111 #0a0a0a black;
				background-image: -webkit-linear-gradient(top, transparent, rgba(0, 0, 0, 0.4));
				background-image: -moz-linear-gradient(top, transparent, rgba(0, 0, 0, 0.4));
				background-image: -o-linear-gradient(top, transparent, rgba(0, 0, 0, 0.4));
				background-image: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.4));
				-webkit-box-shadow: inset 0 1px rgba(255, 255, 255, 0.1), 0 1px 1px rgba(0, 0, 0, 0.2);
				box-shadow: inset 0 1px rgba(255, 255, 255, 0.1), 0 1px 1px rgba(0, 0, 0, 0.2);
			}
			
			.dropdown-dark:before {
				border-bottom-color: #aaa;
			}
			
			.dropdown-dark:after {
				border-top-color: #aaa;
			}
			
			.dropdown-dark .dropdown-select {
				color: #aaa;
				text-shadow: 0 1px black;
				background: #444;
				/* Fallback for IE 8 */
			}
			
			.dropdown-dark .dropdown-select:focus {
				color: #ccc;
			}
			
			.dropdown-dark .dropdown-select>option {
				background: #444;
				text-shadow: 0 1px rgba(0, 0, 0, 0.4);
			}
			
			.weui-cells {
				margin-top: 0px;
			}
			
			.weui-cells__title {
				color: black;
			}
			
			.a-upload {
				padding: 0px 10px;
				width: 80px;
				height: 35px;
				box-sizing: border-box;
				line-height: 31px;
				position: relative;
				cursor: pointer;
				color: #FFFFFF;
				background: #007AFF;
				border: 1px solid #007AFF;
				border-radius: 4px;
				overflow: hidden;
				display: inline-block;
				*display: inline;
				*zoom: 1;
				top: 5px;
			}
			
			.a-upload input {
				position: absolute;
				font-size: 20px;
				opacity: 0;
				filter: alpha(opacity=0);
				cursor: pointer;
				width: 0px;
				height: 30px;
				left: 0;
				top: 0;
			}
			
			.a-upload:hover {
				color: #FFFFFF;
				background: #007AFF;
				border-color: #007AFF;
				text-decoration: none
			}
			
			.kuan input {
				width: 220px;
				height: 40px;
				background: background: 。。。;
				border: none;
				float: left
			}
			
			.an input {
				width: 100px;
				height: 40px;
				background: #1AAD19;
				border: none;
				float: left
			}
		</style>

		<title>新增文章</title>
	</head>

	<body>
		<article class="page-container">
			<form class="form form-horizontal" id="form-article-add">
				<div class="row cl">
					<label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>分类栏目：</label>
					<div class="formControls col-xs-8 col-sm-9"> <span class="select-box">
				<select name="articlecolumn"  id="chnid" class="select">
					<option value="">请选择所属栏目....</option>
								<option v-for="item in items" :value="item.chnid">{{item.cname}}</option>
				</select>
				</span> </div>
				</div>
				<div id="conetent">
				<div class="row cl">
					<label class="form-label col-xs-4 col-sm-2"><span class="c-red">*</span>{{cname.title}}：</label>
					<div class="formControls col-xs-8 col-sm-9">
						<input type="text" class="input-text" value="" placeholder="请输入新闻标题" id="cname" v-model.lazy="cname.message" >
					</div>
				</div>
				<div class="row cl">
					<label class="form-label col-xs-4 col-sm-2">{{fname.title}}：</label>
					<div class="formControls col-xs-8 col-sm-9">
						<input type="text" class="input-text" placeholder="请输入新闻副标题" id="fname" v-model.lazy="fname.message" >
					</div>
				</div>

				<div class="row cl">
					<label class="form-label col-xs-4 col-sm-2">缩略图：</label>
					<div class="formControls col-xs-8 col-sm-9">
						<div style="width: 564px; position: absolute;>
                             <input type=" text "   class="input-text " placeholder="请输入新闻副标题 " value=" " placeholder=" " id="articletitle2 " name="articletitle2 ">
                    	</div>
                    	<div style="margin-left: 564px;>
							<div class="an">
								<image-item href="#" class="a-upload"><input id="upload" type="file" value="搜索" />图片上传</a>
							</div>
						</div>
					</div>
				</div>

				<div id="insert"></div>
				<div class="row cl">
					<button style="float:right" onClick="addDiv()" class="btn btn-secondary radius" type="button">添加段落</button>
					<button style="float:right" onClick="delDiv()" class="btn btn-secondary radius" type="button">删除段落</button>
				</div>
				<div class="row cl">
					<label class="form-label col-xs-4 col-sm-2">{{newszy.title}}：</label>
					<div class="formControls col-xs-8 col-sm-9">
						<textarea name="abstract" cols="" rows="" class="textarea" placeholder="请输入新闻摘要...最少输入10个字符" datatype="*10-100" dragonfly="true" nullmsg="备注不能为空！" onKeyUp="$.Huitextarealength(this,200)"></textarea>
						<p class="textarea-numberbar"><em class="textarea-length">0</em>/200</p>
					</div>
				</div>

				<div class="row cl">
					<label class="form-label col-xs-4 col-sm-2">允许评论：</label>
					<div class="formControls col-xs-8 col-sm-9 skin-minimal">
						<div class="check-box">
							<input type="checkbox" id="allowcomments" name="allowcomments" value="">
							<label for="checkbox-pinglun">&nbsp;</label>
						</div>
					</div>
				</div>

				<div class="row cl">
					<div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-2">
						<button onClick="article_save_submit();" class="btn btn-primary radius" type="submit"><i class="Hui-iconfont">&#xe632;</i> 保存并提交审核</button>
						<button onClick="article_save();" class="btn btn-secondary radius" type="button"><i class="Hui-iconfont">&#xe632;</i> 保存草稿</button>
						<button onClick="removeIframe();" class="btn btn-default radius" type="button">&nbsp;&nbsp;取消&nbsp;&nbsp;</button>
					</div>
				</div>
				</div>
			</form>
		</article>
		<script src="../../js/vue.js"></script>
		<script type="text/javascript" src="../../js/utils/storageutil.js"></script>
		<!--<script src="../../js/utils/cryption.js"></script>-->
		<script src="../../js/utils/utils.js"></script>
		<!--<script src="../../js/lib/plupload/moxie.min.js"></script>-->
		<!--<script src="../../js/lib/plupload/plupload.dev.js"></script>-->
		<!--<script src="../../js/lib/qiniu/qiniu.min.js"></script>-->
		<!--<script src="../../js/utils/cloudutil.js"></script>-->
		<script type="text/javascript" src="../../js/H-ui.admin/lib/jquery/1.9.1/jquery.min.js"></script>
		<!--<script src="../../js/H-ui.admin/static/h-ui/js/H-ui.min.js"></script>-->
		<!--<script type="text/javascript">
		document.write("<s" + "cript type='text/javascript' src='../../js/importJS.js?" + Math.random() + "'></s" + "cript>");
	</script>-->
		<script type="text/javascript">
			var vm_loading; //等待框

			var count1 = 0;
			var fileUploader; //上传logo七牛对象
			var bannerUploader; //上传banner七牛对象
			var uptokenData; //上传的token
			var imgurl = ""; //圖片地址   
			var FileDataArray = new Array(); //附件参数
			var imgName;
			var PriNewsId;

			var objArray = new Array();
			//所属栏目下拉框
			var vue_input = new Vue({
				el: '#chnid',
				data: {
					items: []
				}
			});
			var vm = new Vue({
				el: '#conetent',
				data: {
					editName: '',
					cname: {
						title: "新闻标题",
						message: ""
					},
					fname: {
						title: "新闻副标题",
						message: ""
					},
					newscontent: {
						title: "新闻内容",
						message: ""
					},
					newszy: {
						title: "新闻摘要",
						message: ""
					},
					linkurl: {
						title: "引用地址",
						message: ""
					},
					islink: {
						title: "是否为引用",
						check: true
					},
					isReply: {
						title: "是否允许回复",
						check: true
					},
				},
				computed: {
					// a computed getter
					write: function() {
						return !this.islink.check
					}
				},
				methods: {
					submitClick: function() {}
				}
			})
            			//初始化页面
			window.onload = function() {
				//初始化上传控件
				//initUploaderfj();
				//添加一个段落
				addDiv();
				var detail = utils.getDataFromUrl(window.location.href);
				vm.type = detail.type;
				PriNewsId = detail.newsid;
				var insertText;
				if(vm.type == 'edit') {
					var tempData = {
						cmd: 'news', //网站栏目
						type: 'findpage', //分页查找栏目列表
						newsid: PriNewsId, //文章id
						pagesize: 999, //每页条数  
						pageindex: 1 //页码 
					}

					unitWebsitePro(tempData, function(data) {
						vm.editName = '保存';
						$("#chnid option:selected").val(PriNewsId);
						$("#chnid option:selected").text(detail.cname)
						vm.cname.message = data.RspData.dt[0].topic;
						vm.fname.message = data.RspData.dt[0].subtopic;
						vm.linkurl.message = data.RspData.dt[0].quourl;
						vm.isReply.check = data.RspData.dt[0].isreply;
						vm.islink.check = data.RspData.dt[0].isquo;
						vm.newszy.message = data.RspData.dt[0].summas;
						document.getElementById("filename").value = data.RspData.dt[0].imgurl;
						insertText = data.RspData.dt[0].content;
						var n = (insertText.split('<section>')).length - 1;
						for(var i = 0; i < n - 1; i++) {
							addDiv();
						}
						var k = insertText.replace(/<section>/g, "</section>");
						var ss = k.split('</section>');
						for(var i = 0; i < ss.length; i++) {
							if(ss[i] == '' || ss[i] == null || typeof(ss[i]) == undefined) {
								ss.splice(i, 1);
								i = i - 1;
							}
						}
						if(ss.length > 0) {
							//准备创建控件,多少纬就创建多少个段落控件
							var duanluokongjian = '';
							for(var i = 0; i < ss.length; i++) {
								var p = ss[i].replace(/<p>/g, "</p>"); //将p替换成/p,准备按/p标签拆分
								var pp = p.split('</p>');
								var allInputst1 = $("*[name='dlt']");
								var hh = pp[0].replace(/<[^>]+>/g, "");
								var imgstring = pp[3];
								var zfc = imgstring.substring(9);
								zfc = zfc.substring(0, zfc.length - 1);
								document.getElementById("title" + i).value = hh;
								document.getElementById("conten" + i).value = pp[1];
								document.getElementById("Priimgname" + i).value = zfc;
								//pp[0]即为h3内容,再同理按h3替换拆h3 
								duanluokongjian += pp[0] + '-------';
								var hh = pp[0].replace(/<[^>]+>/g, "");
								//pp[1]为content内容
								duanluokongjian += pp[1] + '-------';
								//pp[3]为img内容,再同理按src特征取到src内的路径
								duanluokongjian += pp[3] + '-------';
								//得到三者后创建相应控件并赋值 	 
							}
						}
						for(var item in vm.$data) {
							(function addwatch(key) {
								vm.$watch(key + '.message', function(newVal, oldVal) {
									edit(oldVal, newVal, key, zfc)
								})
								vm.$watch(key + '.check', function(newVal, oldVal) {
									edit(oldVal, newVal, key, zfc)
								})
							})(item)
						}
					});
				}
				/**
				 * 获取网站配置信息   
				 */
				var webConfig;
				var tempData = {
					cmd: 'webcfg',
					type: 'find'
				}
				unitWebsitePro(tempData, function(data) {
					console.log('配置为:' + JSON.stringify(data));
					if(data.RspCode == 0) {
						if(data.RspData.length > 0) {
							webConfig = data.RspData[0];
							if(webConfig.isreply == 0) //0表示禁止回复，并隐藏回复功能
								document.getElementById('onisReply').style.display = "none";
							if(webConfig.isfileup == 0) //0表示禁止上传，并隐藏回复功能
								document.getElementById('onisfileup').style.display = "none";
						} else {
							weui.alert('没有获取到配置信息')
						}
					} else {
						weui.alert(data.RspTxt);
					}
				});
				/**
				 * 获取网站栏目
				 */
				var tempData = {
					cmd: 'chn', //网站栏目
					type: 'findpage', //分页查找栏目列表 
					pagesize: 999, //每页条数 
					iswrite: '1',
					stat: '1',
					pageindex: 1 //页码  
				}
				var datalm;
				unitWebsitePro(tempData, function(data) {
					if(data.RspCode == 0) {
						if(data.RspData.dt.length > 0) {
							vue_input.items = data.RspData.dt;
							datalm = data.RspData.dt;
						} else {
							alert('暂时还没有栏目');
						}
					} else {
						alert(data.RspTxt);
					}
				});
			}

			function addDiv() {
				//创建一个div 
				var bo = document.getElementById("insert");

				var div = document.createElement('div');
				bo.insertBefore(div, bo.newnode);
				div.className = "italic";
				var ic = count1 + 1;

				if(ic <= 5) {
					for(var i = 0; i < ic; i++) {
						//div.innerHTML = '<div id=\"yc' + count1 + '\"><input name=\"dlt\" id=\"title' + i + '\" placeholder="请输入节标题" onchange=\"upperCase(this.id,' + i + ')\"  type="text"  ><input name=\"dlc\" id=\"conten' + i + '\"   v-model.lazy=\"newscontent.message\" class=\"weui-input\" placeholder=\"请输入新闻内容\" onchange=\"upperCase(this.id,' + i + ')\" style=\"border-color: white;height: 7rem;\ /"><div class=\"kuan\"><input name=\"dle\" id=\"Priimgname' + i + '\" type=\"text\"   onpropertychange=\"upperCase(this.id,' + i + ')\" /></div><div class=\"an\"><a href=\"#\" style=\"float:right\" class=\"a-upload\"><input id=\"Prifile' + i + '\" type=\"file\"  />上传图片</a></div></div>';
						div.innerHTML = '<div id=\"yc' + count1 + '\"><div class=\"row cl\"><label class=\"form-label col-xs-4 col-sm-2\">节标题：</label><div class=\"formControls col-xs-8 col-sm-9\"><input type=\"text\" class=\"input-text\" name=\"dlt\" id=\"title' + i + '\" placeholder=\"请输入新闻节标题\"></div></div><div class=\"row cl\"><label class=\"form-label col-xs-4 col-sm-2\">节内容：</label><div class=\"formControls col-xs-8 col-sm-9\"><textarea name=\"dlc\" id=\"conten' + i + '\" cols=\"\" rows=\"\" class=\"textarea\" placeholder=\"请输入新闻节内容\" datatype=\"*10-100\" dragonfly=\"true\" nullmsg=\"备注不能为空！\"></textarea><p class=\"textarea-numberbar\"><em class=\"textarea-length\">0</em>/200</p></div></div><div class=\"row cl\"><label class=\"form-label col-xs-4 col-sm-2\">缩略图：</label><div class=\"formControls col-xs-8 col-sm-9\"><div style=\"width: 564px; position: absolute;><input type=\" text \"   class=\"input-text \" placeholder=\"请输入新闻副标题\ " value=\"\" placeholder=\" \" name=\"dle\" id=\"Priimgname' + i + '\" ></div><div style=\"margin-left: 564px;\"><div class=\"an\"><image-item href=\"#\" class=\"a-upload\"><input id=\"upload\" type=\"file\" value=\"搜索\" />图片上传</a></div></div></div></div></div>';
					}
				} else {
					alert('不能再增加了');
					return;
				}
				console.log('html:' + div.innerHTML);

				var Priid = "Prifile" + count1;
				var Priimgname = "Priimgname" + count1;
				//initUploader(Priid, Priimgname);
				count1++;

			}

			function delDiv() {

				if(count1 == 1) {
					alert('不能再删除了');
					return;
				}
				if(count1 == 2) {
					$("#yc1").empty();
					count1 = count1 - 1;
				} else if(count1 == 3) {
					$("#yc2").empty();
					count1 = count1 - 1;
				} else if(count1 == 4) {
					$("#yc3").empty();
					count1 = count1 - 1;
				} else if(count1 == 5) {
					$("#yc4").empty();
					count1 = count1 - 1;
				}
				var updateConten = "";
				var allInputst1 = $("*[name='dlt']");
				var allInputsc1 = $("*[name='dlc']");
				var allInputse1 = $("*[name='dle']");
				for(var i = 0; i < allInputst1.length; i++) {
					updateConten += '<section><h3>' + allInputst1[i].value + '</h3><p>' + allInputsc1[i].value + '</p><p><img src=' + allInputse1[i].value + '></p></section>';
				}
				alert(updateConten)
				if(FileDataArray == '') {
					for(var i = 0; i < allInputse1.length; i++) {
						var newsname = allInputse1[i].value.substring(45);
						var person2 = new Object();
						person2.newsid = PriNewsId; //文章id
						person2.saveurl = allInputse1[i].value; //图片地址
						person2.imgurl = allInputse1[i].value;
						person2.oldname = '';
						person2.newname = newsname;
						person2.filesize = '45';
						FileDataArray.push(person2);
					}
				}
				var para = {
					cmd: 'news',
					type: 'edit',
					colid: PriNewsId,
					callcol: 'content',
					encs: FileDataArray,
					colv: updateConten
				}
				unitWebsitePro(para, function(data) {});

				//确定删除

			}
		</script>
	</body>

</html>