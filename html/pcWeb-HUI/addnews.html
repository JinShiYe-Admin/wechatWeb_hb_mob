<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>新闻添加</title>
		<link rel="stylesheet" type="text/css" href="../../js/H-ui.admin/static/h-ui/css/H-ui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../js/H-ui.admin/lib/Hui-iconfont/1.0.8/iconfont.css" />
		<style>
			.edit_container {
				margin: 0 auto;
				width: 1080px;
			}
			
			.input-text:not(.piece) {
				width: 100%;
				border: 0;
				border-bottom: 1px solid #DDDDDD;
			}
			
			.input-text.piece {
				border: 0;
			}
			
			.float-right {
				float: right;
			}
			
			.artical-url.input-text {
				width: 90%;
				border: none;
			}
			
			.artical-pieces-title {
				font-size: 18px;
				padding: 10px 0 0 8px;
			}
			
			.check-box,
			.radio-box {
				padding-left: 0px;
			}
		</style>
	</head>

	<body>
		<nav class="breadcrumb"><i class="Hui-iconfont">&#xe67f;</i> 首页 <span class="c-gray en">&gt;</span> 新闻 <span class="c-gray en">&gt;</span> 新闻添加
			<a class="btn btn-success radius r" style="line-height:1.6em;margin-top:3px" href="javascript:location.replace(location.href);" title="刷新"><i class="Hui-iconfont">&#xe68f;</i></a>
		</nav>
		<div id="artical-pub">
			<div class="edit_container">
				<div>
					<select class="select" id="chnid" name="one" style="height: 45px;font-size: 17px;color: #929292;">
					 
						<option v-for="item in items" :value="item.chnid">{{item.cname}}</option>
					</select>
				</div>
				<input v-model.trim="artical.topic" id="cname" class="artical-title input-text size-L" type="text" maxlength="64" placeholder="在此输入标题" />
				<input v-model.trim="artical.subtopic" id="fname" class="artical-subtitle input-text size-L" type="text" maxlength="64" placeholder="在此输入副标题" />
				<textarea v-model.trim="artical.summas" id="summas" class="textarea" placeholder="在此输入新闻摘要"></textarea>
				<select-load-pic v-bind:index="-1" v-on:uploadedfile="getHeadImg"></select-load-pic>
				<p class="artical-pieces-title">新闻内容</p>
				<template v-for="(piece,index) in pieces">
					<div class="artical-piece">
						<input class="piece-title input-text size-L" v-model.trim="piece.title" type="text" maxlength="64" placeholder="在此输入节标题" />
						<textarea class="piece-container textarea radius" v-model.trim="piece.content" placeholder="在此输入节内容"></textarea>
					</div>
					<div>
						<p v-if="piece.files.lenth>0"></p>
						<select-load-pic :index="index" v-on:uploadedfile="getPieceImg"></select-load-pic>
						<input id="add-piece" v-if="pieces.length<5" v-on:click="addPiece(piece,index)" class="btn btn-primary radius float-right" type="button" value="添加段落">
						<input id="del-piece" v-if="index>0" v-on:click="delPiece(piece,index)" class="btn btn-warning radius float-right" type="button" value="删除段落">
					</div>
				</template>
				<br />
				<span><i class="icon Hui-iconfont Hui-iconfont-more2"></i></span><input type="url" id="islink" v-model.trim="artical.quourl" class="artical-url input-text size-L" placeholder="请输入原文链接" />
				<div>
					<div class="check-box">
						<label for="checkbox-1">是否可评论</label>
						<input type="checkbox" id="isReply">
					</div>
					<input class="btn btn-primary radius float-right" v-on:click="publishArtical" type="button" value="发送">
				</div>
			</div>
			<div id="dia-delPiece" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content radius">
						<div class="modal-header">
							<h3 class="modal-title">删除段落</h3>
							<a class="close" data-dismiss="modal" aria-hidden="true" href="javascript:void();">×</a>
						</div>
						<div class="modal-body">
							<p>确认删除此段落？</p>
						</div>
						<div class="modal-footer"><br />
							<button class="btn btn-primary" v-on:click="sureDelPiece(curPiece.index)">确定</button>
							<button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../js/vue.js"></script>
	<script type="text/javascript" src="../../js/utils/storageutil.js"></script>
	<script src="../../js/utils/cryption.js"></script>
	<script src="../../js/utils/utils.js"></script>
	<script src="../../js/lib/plupload/moxie.min.js"></script>
	<script src="../../js/lib/plupload/plupload.dev.js"></script>
	<script src="../../js/lib/qiniu/qiniu.min.js"></script>
	<script src="../../js/utils/cloudutil.js"></script>
	<script src="../../js/pcWeb-HUI/select-load-singPic.js"></script>
	<script type="text/javascript" src="../../js/H-ui.admin/lib/jquery/1.9.1/jquery.min.js"></script>
	<script src="../../js/H-ui.admin/static/h-ui/js/H-ui.min.js"></script>
	<script src="../../js/utils/utils.js"></script>
	<script src="../../js/pcWeb-HUI/select-load-singPic.js"></script>
	<script type="text/javascript" src="../../js/H-ui.admin/lib/jquery/1.9.1/jquery.min.js"></script>
	<script type="text/javascript">
		document.write("<s" + "cript type='text/javascript' src='../../js/importJS.js?" + Math.random() + "'></s" + "cript>");
	</script>
	<script src="../H-ui.admin/static/h-ui/js/H-ui.min.js"></script>
	<script>
		var vm_loading; //等待框
		var fileUploader; //上传logo七牛对象
		var bannerUploader; //上传banner七牛对象
		var uptokenData; //上传的token
		var imgurl = ""; //圖片地址   
		var bjimgurl = ""; //圖片地址   
		var FileDataArray = new Array(); //附件参数
		var imgList=new Array();
		var imgName;
		var dlindex;
		var PriNewsId;
		var detail;
		var objArray = new Array();
		//所属栏目下拉框
			var vue_input = new Vue({
				el: '#chnid',
				data: {
					items: [ 
					]
				},
				methods: {}
			});
		//初始化页面
		window.onload = function() {
			detail = utils.getDataFromUrl(window.location.href);
			PriNewsId = detail.newsid;
			alert('新闻id'+PriNewsId)
			var insertText;
			if(detail.type == 'edit') {
				var tempData = {
					cmd: 'news', //网站栏目
					type: 'findpage', //分页查找栏目列表
					newsid: PriNewsId, //文章id
					pagesize: 999, //每页条数  
					pageindex: 1 //页码 
				}
//				unitWebsitePro(tempData, function(data) {
					//vm.editName = '保存';
					$("#chnid option:selected").val(PriNewsId);
					$("#chnid option:selected").text(detail.cname)
									articalPublish.artical.chind = 1;
									articalPublish.artical.topic = "新闻标题测试";
									articalPublish.artical.subtopic = "新闻副标题测试";
									articalPublish.artical.summas = "新闻摘要测试";
									articalPublish.artical.isquo = 0;
									articalPublish.artical.isreply = 1;
//					articalPublish.artical.topic = data.RspData.dt[0].topic;
//					articalPublish.artical.subtopic = data.RspData.dt[0].subtopic; //新闻副标题
//					articalPublish.artical.summas = data.RspData.dt[0].summas; //新闻摘要
//					articalPublish.artical.isquo = data.RspData.dt[0].quourl;
//					articalPublish.artical.isreply = data.RspData.dt[0].isreply;
//					bjimgurl= data.RspData.dt[0].imgurl;
                    bjimgurl= "http://qn-cspb.jiaobaowang.net/wechat/webcon/1506580480781460.png";
					//insertText = data.RspData.dt[0].content;
					insertText = "<section><h3></h3><p>本网消息（文/李科 图/潇潇）9月27日上午，成都市审计局与成都大学政校合作战略框架协议签字暨成都市审计学会授牌仪式在学术会议室举行。校长王清远、市审计局局长曾军出席仪式并致辞。党委副书记、纪委书记易贤文主持签字授牌仪式。</p><p><img src=http://qn-cspb.jiaobaowang.net/wechat/webcon/1506580422165139.png></p></section><section><h3></h3><p>王清远在致辞中说，当前学校正按照市委市政府提出的“高水平办好成都大学”的总体要求，努力建设高水平应用型综合大学，培养高素质应用型人才，学校教学科研、服务地方、校城融合、协同育人等方面工作不断取得突出进展，办学实力显著增强，呈现出良好发展势头。他表示，希望以此为契机，全面加强与市审???局的全方位、深度合作，发挥综合性大学多学科优势，做好成都市审计学会工作，共同为地方审计业务工作、审计人才培养、审计事业发展贡献更大力量。</p><p><img src=http://qn-cspb.jiaobaowang.net/wechat/webcon/1506580446369615.png></p></section><section><h3></h3><p>曾军说，近年来，国家十分重视审计事业发展，对审计工作的要求越来越高，审计事业迎来新机遇和新挑战，为政校合作创造了空间，此次政校合作协议签订是成都审计事业发展中的一件大事。他表示，地方需要大量交叉型、复合型专业审计人才，成都大学有丰富科研资源和雄厚科研力量，有优秀教育培训专家，双方整合资源，深化合作，积极作为，将为学校审计人才培养，地方审计事业发展作出贡献，为国家中心城市建设舔砖加瓦。</p><p><img src=http://qn-cspb.jiaobaowang.net/wechat/webcon/1506580469701259.png></p></section><section><h3></h3><p>签??及挂牌仪式结束后，召开了成都市审计学会新一届会员代表大会。成都市审计局副局长李永平，副校长彭晓琳，以及双方相关职能部门负责人和成都市各区（市）、县审计局负责人参加相关活动。</p><p><img src=http://qn-cspb.jiaobaowang.net/wechat/webcon/1506580480781460.png></p></section>";
					var n = (insertText.split('<section>')).length - 1;
				    alert(n)
					for(var i = 0; i < n - 1; i++) {
//					 this.pieces.splice(i + 1, 0, {
//						title: "",
//						content: "",
//						files: ""
					//})
						 
					}
					var k = insertText.replace(/<section>/g, "</section>");
					var ss = k.split('</section>');
					for(var i = 0; i < ss.length; i++) {
						if(ss[i] == '' || ss[i] == null || typeof(ss[i]) == undefined) {
							ss.splice(i, 1);
							i = i - 1;
						}
					}
					if(ss.length > 0) {
						//准备创建控件,多少纬就创建多少个段落控件
						var duanluokongjian = '';
						alert('ss'+ss.length)
						for(var i = 0; i < ss.length; i++) {
							var p = ss[i].replace(/<p>/g, "</p>"); //将p替换成/p,准备按/p标签拆分
							var pp = p.split('</p>');
							var hh = pp[0].replace(/<[^>]+>/g, "");
							var imgstring = pp[3];
							var zfc = imgstring.substring(9);
							zfc = zfc.substring(0, zfc.length - 1);
							alert('标题'+hh);
							alert('内容'+pp[1]);
							alert('图片'+zfc);
							calPublish.pieces.title = hh;
							articalPublish.pieces.content = pp[1];
							articalPublish.pieces.files = zfc;
							//pp[0]即为h3内容,再同理按h3替换拆h3 
							duanluokongjian += pp[0] + '-------';
							//var hh = pp[0].replace(/<[^>]+>/g, "");
							//pp[1]为content内容
							duanluokongjian += pp[1] + '-------';
							//pp[3]为img内容,再同理按src特征取到src内的路径
							duanluokongjian += pp[3] + '-------';
							//得到三者后创建相应控件并赋值 	 
						}
					}
					for(var item in articalPublish.$data) {
						(function addwatch(key) {
							articalPublish.$watch(key + '.message', function(newVal, oldVal) {
								edit(oldVal, newVal, key, zfc)
							})
							articalPublish.$watch(key + '.check', function(newVal, oldVal) {
								edit(oldVal, newVal, key, zfc)
							})
						})(item)
					}
				//});
			}
			/**
			 * 获取网站配置信息   
			 */
			//				var webConfig;
			//				var tempData = {
			//					cmd: 'webcfg',
			//					type: 'find'
			//				}
			//				unitWebsitePro(tempData, function(data) {
			//					console.log('配置为:' + JSON.stringify(data));
			//					if(data.RspCode == 0) {
			//						if(data.RspData.length > 0) {
			//							webConfig = data.RspData[0];
			//							if(webConfig.isreply == 0) //0表示禁止回复，并隐藏回复功能
			//								document.getElementById('onisReply').style.display = "none";
			//							if(webConfig.isfileup == 0) //0表示禁止上传，并隐藏回复功能
			//								document.getElementById('onisfileup').style.display = "none";
			//						} else {
			//							weui.alert('没有获取到配置信息')
			//						}
			//					} else {
			//						weui.alert(data.RspTxt);
			//					}
			//				});

		}
		var PriConten = "";
		var articalPublish = new Vue({
			el: "#artical-pub",
			data: {
				artical: {
					//chind: -1, //所属栏目id
					topic: "", //标题
					subtopic: "", //副标题
					summas: "", //摘要
					content: "", //内容
					isquo: 0, //是否引用
					quourl: "", //引用url
					isreply: 0, //是否允许回复，
					encs: [
						//					{oldname:"",//原名称
						//					newname:"",//新名称
						//					saveurl:"",//存储url
						//					filesize:"",//文件大小
						//					imgurl:""//缩略图
						//					}
					], //附件列表
					stat: "" //根据配置表设置相应值
				},
				pieces: [{
					title: "",
					content: "",
					files: "" 
				}],
				curPiece: {
					piece: null,
					index: -1
				},
				columns: []
			},
			created: function() {
				//vue 创建时 请求栏目列表
				this.getColumns();
			},
			watch: {
				pieces: function(newVal, oldVal) { //片段增减的判断
					console.log("newVal" + JSON.stringify(newVal));
					console.log("oldVal:" + JSON.stringify(oldVal));
				}
			},
			methods: {
				publishArtical: function() { //发布文章  
					 
                    var dl=JSON.stringify(articalPublish.pieces); 
					for(var i = 0; i < articalPublish.pieces.length; i++) { 
						PriConten += '<section><h3>' + articalPublish.pieces[i].title + '</h3><p>' + articalPublish.pieces[i].content + '</p><p><img src=' + articalPublish.pieces[i].files + '></p></section>';
					}
                    alert( PriConten)
					var comData = '';
					var PriChnid = $("#chnid option:selected").val();
					console.log('所属栏目=========================:' + PriChnid);
					var PriIsquo = document.getElementById("islink").checked == true ? 1 : 0;
					var PriIsReply = document.getElementById("isReply").checked == true ? 1 : 0;
					var PriQuourl = document.getElementById("islink").value;
					console.log('附件=========================:' + JSON.stringify(FileDataArray));
					var PriFileData = JSON.stringify(FileDataArray);
					comData = {
						cmd: 'news', //文章管理
						type: 'add',
						chnid: PriChnid,
						subtopic: articalPublish.artical.subtopic,
						topic: articalPublish.artical.topic,
						content: PriConten,
						summas: articalPublish.artical.summas,
						encs: FileDataArray,
						isquo: PriIsquo,
						quourl: PriQuourl,
						isreply: PriIsReply,
						stat: 1
					};
					console.log('comData=========================:' + JSON.stringify(comData));
					unitWebsitePro(comData, function(data) {
						if(data.RspCode == 0) {
							//$.Huimodalalert('添加成功', 1000);
							alert('添加成功');
							location.reload();
						} else {
							//$.Huimodalalert(data.RspTxt, 1000);
						}
					});
				},
				getColumns: function() { //获取栏目列表  
				var tempData = {
					cmd: 'chn', //网站栏目
					type: 'findpage', //分页查找栏目列表
					pagesize: 999, //每页条数 
					pageindex: 1 //页码 
				} 
					unitWebsitePro(tempData, function(data) {  
						if(data.RspCode == 0) { 
							if(data.RspData.dt.length > 0) {
							    alert(JSON.stringify(data.RspData.dt));
								vue_input.items = data.RspData.dt; 
							} else {
								//$.Huimodalalert('暂时还没有栏目', 1000);
								alert('暂时还没有栏目');
							}
						} else {
							//$.Huimodalalert(data.RspTxt, 1000);	
							alert(data.RspTxt);
						}
					});
				},
				addPiece: function(piece, index) { //增加文章片段
					if(!piece.title || !piece.content) {
						//$.Huimodalalert('段落未添加标题或内容，无法继续添加', 3000)
						alert('段落未添加标题或内容，无法继续添加');
						return;
					}
					this.pieces.splice(index + 1, 0, {
						title: "",
						content: "",
						files: ""
					})
					dlindex=index;
					
				},
				delPiece: function(piece, index) {
					if(piece.title || piece.content || piece.files.length > 0) {
						this.curPiece = {
							piece: piece,
							index: index
						}
						$("#dia-delPiece").modal("show")
						return;
					}
					console.log("要删除的控件：" + index);
					this.sureDelPiece(index);
				},
				sureDelPiece: function(index) {
					 
					this.pieces.splice(index, 1);
					$("#dia-delPiece").modal("hide");
				},
				getHeadImg: function(headImg, index) {
					console.log("*****获取的headImg:" + JSON.stringify(headImg) + ",index:" + index); 
					imgurl = headImg.ImgUrl;
					var person = new Object();
					//person.encid = priid; //控件id
					person.saveurl = headImg.SaveUrl; //图片地址
					person.imgurl = headImg.ImgUrl;
					person.oldname = headImg.OldName;
					person.newname = headImg.NewName;
					person.filesize = headImg.FileSize;
					//循环附件数组，判断id是否有重复
//					for(var i = 0; i < FileDataArray.length; i++) {
//						if(FileDataArray[i].id == priid) {
//							//如果有重复则移除原来的
//							FileDataArray.splice(i, 1);
//						}
//					}
					//添加新的附件 
					FileDataArray.push(person); 
				},
				getPieceImg: function(contentImg, index) {
					console.log("*****获取的contentImage:" + JSON.stringify(contentImg) + ",index:" + index);
					var imgsz = new Object();
					imgsz.img= contentImg.ImgUrl;
					imgsz.index=index;
					imgList.push(imgsz);
                    imgurl = contentImg.ImgUrl;
                    articalPublish.pieces.files=contentImg.ImgUrl;
					var person = new Object();
					//person.encid = priid; //控件id
					person.saveurl = contentImg.SaveUrl; //图片地址
					person.imgurl = contentImg.ImgUrl;
					person.oldname = contentImg.OldName;
					person.newname = contentImg.NewName;
					person.filesize = contentImg.FileSize;
					//循环附件数组，判断id是否有重复
//					for(var i = 0; i < FileDataArray.length; i++) {
//						if(FileDataArray[i].id == priid) {
//							//如果有重复则移除原来的
//							FileDataArray.splice(i, 1);
//						}
//					}
					//添加新的附件 
					FileDataArray.push(person); 
				}
			}
		})
	</script>

</html>