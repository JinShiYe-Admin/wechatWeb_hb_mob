<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>webCamera</title>
	</head>

	<body>
		<div>webCamera</div>
		<video id="video" style="width: 100%;height: 200px;background:black;" controls></video>
		<button onclick="clickbtn(0)">mediaDevices</button>
		<button onclick="clickbtn(1)">getUserMedia</button>
		<button onclick="clickbtn(2)">webkitGetUserMedia</button>
		<button onclick="clickbtn(3)">mozGetUserMedia</button>
		<div id="option">摄像头：默认</div>
		<button onclick="clickbtn(4)">前置摄像头</button>
		<button onclick="clickbtn(5)">后置摄像头</button>
		<button onclick="clickbtn(6)">默认摄像头</button>
		<input id="input" type="file" accept="video/*">
		<!--<script type="text/javascript" src="js/vconsole.min.js?"></script>-->
		<script type="text/javascript" src="../../js/lib/vconsole/vconsole.min.js?"></script>

		<script>
			var mediaOpts = {
				audio: true,
				video: true,
			}
			var option = document.getElementById("option");
			var video = document.getElementById("video");
			//iOS获取视频
			var inputVideo = document.getElementById("input");
			inputVideo.addEventListener("change", function(e) {
				var url = URL.createObjectURL(e.target.files[0]);
				console.log("url:" + url);
				video.src = url;
			});

			var exArray = []; //存储设备源ID
			//获取视频，音频的设备信息
			MediaStreamTrack.getSources(function(sourceInfos) {
				console.log("sourceInfos", sourceInfos);
				for(var i = 0; i != sourceInfos.length; ++i) {
					var sourceInfo = sourceInfos[i];
					//这里会遍历audio,video，所以要加以区分
					if(sourceInfo.kind === 'video') {
						exArray.push(sourceInfo.id);
					}
				}
			});

			/**
			 * 成功获取视频流
			 * @param {Object} stream
			 */
			function successFunc(stream) {
				console.log("successFunc");
				if("srcObject" in video) {
					console.log("srcObject");
					video.srcObject = stream;
				} else {
					video.src = window.URL && window.URL.createObjectURL(stream) || stream;
					console.log("video.src:" + video.src);
				}
				video.play();
			}

			function errorFunc(err) {
				console.log("errorFunc");
				console.log("err", err);
			}

			function clickbtn(num) {
				console.log("clickbtn:" + num);
				switch(num) {
					case 0:
						var p = navigator.mediaDevices.getUserMedia(mediaOpts);
						p.then(successFunc);
						p.catch(errorFunc);
						break;
					case 1:
						navigator.getUserMedia(mediaOpts, successFunc, errorFunc);
						break;
					case 2:
						navigator.webkitGetUserMedia(mediaOpts, successFunc, errorFunc);
						break;
					case 3:
						navigator.mozGetUserMedia(mediaOpts, successFunc, errorFunc);
						break;
					case 4: //前置摄像头
						mediaOpts = {
							audio: true,
							video: {
								optional: [{
									sourceId: exArray[0] //0为前置摄像头，1为后置
								}]
							}
						}
						option.innerText = "摄像头：前置";
						break;
					case 5: //后置摄像头
						mediaOpts = {
							audio: true,
							video: {
								optional: [{
									sourceId: exArray[1] //0为前置摄像头，1为后置
								}]
							}
						}
						option.innerText = "摄像头：后置";
						break;
					case 6: //默认摄像头
						mediaOpts = {
							audio: true,
							video: true
						}
						option.innerText = "摄像头：默认";
						break;
				}
			}

			window.onload = function() {
				console.log("navigator.mediaDevices:" + navigator.mediaDevices);
				console.log("navigator.getUserMedia:" + navigator.getUserMedia);
				console.log("navigator.webkitGetUserMedia :" + navigator.webkitGetUserMedia);
				console.log("navigator.mozGetUserMedia :" + navigator.mozGetUserMedia);

				// getUserMedia 被标准废除了，mediaDevices 正在取代中
				if(navigator.mediaDevices === undefined) {
					console.log("000000");
				} else {
					console.log("111111");
					console.log("navigator.mediaDevices.getUserMedia:" + navigator.mediaDevices.getUserMedia);
				}
			}
		</script>
	</body>

</html>