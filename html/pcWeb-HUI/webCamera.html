<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>webCamera</title>
	</head>

	<body>
		<div>webCamera</div>
		<div>video</div>
		<video id="video" style="width: 100%;height: 200px;background:black;" controls autoplay></video>
		<div>record</div>
		<video id="record" style="width: 100%;height: 200px;background:black;" controls autoplay></video>
		<button onclick="clickbtn(0)">mediaDevices</button>
		<button onclick="clickbtn(1)">getUserMedia</button>
		<button onclick="clickbtn(2)">webkitGetUserMedia</button>
		<button onclick="clickbtn(3)">mozGetUserMedia</button>
		<div id="option">摄像头：默认</div>
		<button onclick="clickbtn(4)">前置摄像头</button>
		<button onclick="clickbtn(5)">后置摄像头</button>
		<button onclick="clickbtn(6)">默认摄像头</button>
		<input id="input" type="file" accept="video/*">
		<br />
		<button onclick="clickbtn(7)">安卓录制</button>
		<button onclick="clickbtn(8)">显示视频1</button>
		<button onclick="clickbtn(9)">显示视频2</button>
		<a id="download_1" download>文件1</a>
		<a id="download_2" download>文件2</a>

		<br />
		<!--<button onclick="clickbtn(8)">上传录制的视频</button>-->

		<!--<script type="text/javascript" src="js/vconsole.min.js?"></script>-->
		<script type="text/javascript" src="../../js/lib/vconsole/vconsole.min.js?"></script>

		<script>
			var mediaOpts = {
				audio: true,
				video: true,
			}
			var blobType = 'video/webm';
			var cameraStream;
			var uploadFile;
			var mediaRecorder;
			var chunks = [];
			var videoBlob;
			var videoBlobA;
			var videoBlobB;
			var option = document.getElementById("option");
			var video = document.getElementById("video");
			var record = document.getElementById("record");
			record.onerror = function(e) {
				console.log("record.onerror", record.error);
			}

			//iOS获取视频
			var inputVideo = document.getElementById("input");
			inputVideo.addEventListener("change", function(e) {
				console.log("change", e.target.files);
				var url = URL.createObjectURL(e.target.files[0]);
				console.log("url:" + url);
				record.src = url;
				record.play();
			});

			var exArray = []; //存储设备源ID
			//获取视频，音频的设备信息
			if(MediaStreamTrack && MediaStreamTrack.getSources) {
				MediaStreamTrack.getSources(function(sourceInfos) {
					console.log("sourceInfos", sourceInfos);
					for(var i = 0; i != sourceInfos.length; ++i) {
						var sourceInfo = sourceInfos[i];
						//这里会遍历audio,video，所以要加以区分
						if(sourceInfo.kind === 'video') {
							exArray.push(sourceInfo.id);
						}
					}
				});
			} else {
				console.log("没有摄像头和麦克风设备")
			}

			if(window.MediaRecorder != undefined) {
				console.log("支持的录制格式video/webm", MediaRecorder.isTypeSupported("video/webm"));
				console.log("支持的录制格式video/mp4", MediaRecorder.isTypeSupported("video/mp4"));
				console.log("支持的录制格式video/mpeg", MediaRecorder.isTypeSupported("video/mpeg"));
				console.log("支持的录制格式video/quicktime", MediaRecorder.isTypeSupported("video/quicktime"));
				console.log("支持的录制格式video/ogg", MediaRecorder.isTypeSupported("video/ogg"));
			} else {
				console.log("不支持录制视频");
			}

			/**
			 * 成功获取视频流
			 * @param {Object} stream
			 */
			function successFunc(stream) {
				cameraStream = stream;
				console.log("successFunc", cameraStream);
				if("srcObject" in video) {
					console.log("srcObject");
					video.srcObject = cameraStream;
				} else {
					video.src = window.URL && window.URL.createObjectURL(cameraStream) || cameraStream;
					console.log("video.src:" + video.src);
				}
				video.play();
			}

			function errorFunc(err) {
				console.log("errorFunc");
				console.log("err", err);
			}

			function clickbtn(num) {
				console.log("clickbtn:" + num);
				switch(num) {
					case 0:
						var p = navigator.mediaDevices.getUserMedia(mediaOpts);
						p.then(successFunc);
						p.catch(errorFunc);
						break;
					case 1:
						navigator.getUserMedia(mediaOpts, successFunc, errorFunc);
						break;
					case 2:
						navigator.webkitGetUserMedia(mediaOpts, successFunc, errorFunc);
						break;
					case 3:
						navigator.mozGetUserMedia(mediaOpts, successFunc, errorFunc);
						break;
					case 4: //前置摄像头
						mediaOpts = {
							audio: true,
							video: {
								optional: [{
									sourceId: exArray[0] //0为前置摄像头，1为后置
								}]
							}
						}
						option.innerText = "摄像头：前置";
						break;
					case 5: //后置摄像头
						mediaOpts = {
							audio: true,
							video: {
								optional: [{
									sourceId: exArray[1] //0为前置摄像头，1为后置
								}]
							}
						}
						option.innerText = "摄像头：后置";
						break;
					case 6: //默认摄像头
						mediaOpts = {
							audio: true,
							video: true
						}
						option.innerText = "摄像头：默认";
						break;
					case 7: //安卓录制
						androidRecord();
						break;
					case 8:
						var url = URL.createObjectURL(videoBlobA);
						var ad = document.getElementById("download_1");
						ad.setAttribute("href", url);
						ad.innerText = "文件1-" + url;
						record.src = url
						record.play();
						break;
					case 9:
						var url = URL.createObjectURL(videoBlob);
						var ad = document.getElementById("download_2");
						ad.setAttribute("href", url);
						ad.innerText = "文件2-" + url;
						record.src = url
						record.play();
						break;
				}
			}

			/**
			 * 安卓录制视频
			 */
			function androidRecord() {
				console.log("androidRecord", cameraStream);
				mediaRecorder = new MediaRecorder(cameraStream);
				console.log("mediaRecorder", mediaRecorder);
				if(mediaRecorder) {
					console.log("开始录制");
					mediaRecorder.onstop = function() {
						console.log("mediaRecorder.onstop");
						console.log("chunks:" + chunks.length);
						videoBlobA = new Blob(chunks, {
							type: blobType
						});
						console.log("videoBlobA:", videoBlobA);
						console.log("videoBlobA:", videoBlobA.size);
						console.log("videoBlob:", videoBlob);
						console.log("videoBlob:", videoBlob.size);
					}
					mediaRecorder.ondataavailable = function(e) {
						chunks.push(e.data);
						videoBlob = new Blob([e.data], {
							type: e.data.type
						});
					}
					mediaRecorder.onstart = function(e) {
						console.log("mediaRecorder.onstart");
					}
					mediaRecorder.start();
					setTimeout(function() {
						console.log("录像结束");
						mediaRecorder.stop();
					}, 10000);
				} else {
					console.log("mediaRecorder 无录制功能");
				}
			}

			window.onload = function() {
				console.log("navigator.mediaDevices:" + navigator.mediaDevices);
				console.log("navigator.getUserMedia:" + navigator.getUserMedia);
				console.log("navigator.webkitGetUserMedia :" + navigator.webkitGetUserMedia);
				console.log("navigator.mozGetUserMedia :" + navigator.mozGetUserMedia);

				// getUserMedia 被标准废除了，mediaDevices 正在取代中
				if(navigator.mediaDevices === undefined) {
					console.log("000000");
				} else {
					console.log("111111");
					console.log("navigator.mediaDevices.getUserMedia:" + navigator.mediaDevices.getUserMedia);
				}
				console.log("navigator", navigator);
			}
		</script>
	</body>

</html>