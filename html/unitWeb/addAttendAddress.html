<!--
	作者：徐邦圣
	时间：2017-11-25
	描述：企业微信后台管理页面，考勤管理模块，点新增考勤地点按钮后跳转到该界面，即新增考勤地点记录界面
-->
<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>管理考勤</title>
		<link rel="stylesheet" href="../../css/weui.min.css" />
		<!--<link href="../../css/mui.min.css" rel="stylesheet" />-->
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=Z5iqNpaPerdxLv1m4Vd6PPgHYMZ3YbqH"></script>
		<style>
			#allmap {
				overflow: hidden;
				margin: 0;
				font-family: "微软雅黑";
			}
			
			.weui-cells {
				margin-top: 0px;
			}
			
			.weui-cells__title {
				color: black;
			}
			/*地图缩放控件层*/
			
			#r-result {
				width: 100%;
				margin-top: 5px;
			}
		</style>
	</head>

	<body>
		<!--<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		</header>-->
		<!--<template>-->
		<div id="conetent" class="weui-cells weui-cells_form mui-hidden">
			<h3 style="text-align: center;">新增考勤地点</h3>
			<!--输入列表-->
			<div id="input_list">
				<div>
					<div class="weui-cells__title">考勤地点名称</div>
					<div class="weui-cells">
						<div class="weui-cell">
							<div class="weui-cell__bd">
								<input id="attendAdressText" v-model.lazy="cname.message" class="weui-input" type="text" :placeholder="'请输入考勤地点名称'">
							</div>
						</div>
					</div>
				</div>

				<!--用来显示地图-->
				<div id="allmap" style="height:500px;width:100%;"></div>

				<div id="r-result">

				</div>
				考勤地点X坐标（经度）：<input type="text" id="longitude" /> 考勤地点Y坐标（纬度）：
				<input type="text" id="latitude" />
				<div class="weui-cells__title ">考勤地点半径</div>
				<div class="weui-cells ">
					<div class="weui-cell ">
						<div class="weui-cell__bd ">
							<input id="attendAddressRedius" class="weui-input " type="text" :placeholder=" '请输入考勤地点半径' ">米（建议500-1000米）
						</div>
					</div>
				</div>
				<div>系统无法获取经纬度时，请使用高德地图查询后手动输入
					<a href="http://lbs.amap.com/console/show/picker">查询</a>
				</div>
			</div>
			<!--开关列表-->
			<div id="switch_list">
				<!--<div>
					<div class="weui-cell weui-cell_switch">
						<div class="weui-cell__bd">{{islink.title}}</div>
						<div class="weui-cell__ft">
							<input class="weui-switch" type="checkbox" v-model="islink.check">
						</div>
					</div>
				</div>-->

				<!--<div>
					<div class="weui-cell weui-cell_switch">
						<div class="weui-cell__bd">{{iswrite.title}}</div>
						<div class="weui-cell__ft">
							<input :disabled="(islink.check)||(iswrite_all==0)" class="weui-switch" type="checkbox" v-model="iswrite.check">
						</div>
					</div>
				</div>

				<div>
					<div class="weui-cell weui-cell_switch">
						<div class="weui-cell__bd">{{istop.title}}</div>
						<div class="weui-cell__ft">
							<input class="weui-switch" type="checkbox" v-model="istop.check">
						</div>
					</div>
				</div>-->
			</div>
			<div class="weui-btn-area" v-if="editName =='添加'">
				<button id="submit" v-on:click="submitClick" class="weui-btn weui-btn_primary">{{editName}}</button>
			</div>
		</div>
		<!--</template>-->
		<!--<script src="../../js/mui.min.js"></script>-->
		<script type="text/javascript" src="../../js/weui.min.js"></script>
		<script type="text/javascript" src="../../js/vue.min.js"></script>
		<!--<script type="text/javascript" src="../../js/jweixin.js"></script>-->
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript">
			document.write("<s" + "cript type='text/javascript' src='../../js/importJS.js?" + Math.random() + "'></s" + "cript>");
		</script>
		<script>
			var corpId = "";
			window.onload = function() {
				/**
				 * 页面一加载，向顾工c#接口代码请求该操作者的信息，目的是拿到该操作者的单位标识
				 */
				var tempData = {
					cmd: 'userinfo',
					type: 'findpage',
					colv: ''
				}

				$.ajax({
					url: "https://jsypay.jiaobaowang.net/wxth/appschweb/schwebapi.aspx",
					type: "POST",
					data: JSON.stringify(tempData),
					timeout: 1000,
					dataType: "json",
					async: false,
					success: function(data) {
						console.log("用户基本信息==============" + JSON.stringify(data))
						if(data.RspCode == 0) {
							var rep = JSON.parse(data.RspData);

							corpId = rep.corpid;

						} else if(data.RspCode == 7) {
							$.toast("登录超时，请重新进入APP", "cancel", function() {
								console.log('close');
							});
						}
					},
					error: function() {
						console.log("error");
					}
				})
				//给corpId赋值假数据
//				corpId = "wx6c4528c675d4a9c9";
				//	getWebsitConfig();
				var detail = utils.getDataFromUrl(window.location.href);
				//				alert("detail " + JSON.stringify(detail));
				vm.type = detail.type;
				if(vm.type == 'edit') {
					var tempData = {
						cmd: 'chn',
						type: 'findpage',
						pagesize: '1',
						pageindex: '1',
						chnid: detail.chnid
						//				cname: '',
						//				stat: '',
						//				iswrite: '',
						//				islink: ''
					}
					unitWebsitePro(tempData, function(data) {
						//				alert(JSON.stringify(data));
						if(data.RspCode == 0) {
							detail = data.RspData.dt[0];
							vm.editName = '删除'
							vm.colid = detail.chnid;
							vm.cname.message = detail.cname;
							vm.orderid.message = detail.orderid;
							vm.linkurl.message = detail.linkurl;
							vm.islink.check = detail.islink == 1 ? true : false;
							vm.iswrite.check = detail.iswrite == 1 ? true : false;
							vm.istop.check = detail.istop == 1 ? true : false;
							vm.note.message = detail.note
							for(var item in vm.$data) {
								(function addwatch(key) {
									vm.$watch(key + '.message', function(newVal, oldVal) {
										edit(oldVal, newVal, key)
									})
									vm.$watch(key + '.check', function(newVal, oldVal) {
										edit(oldVal, newVal, key)
									})
								})(item)

							}
						} else {
							alert(data.RspTxt);
						}
					});

				} else {
					vm.editName = '添加'
					vm.$watch('islink.check', function(newVal, oldVal) {
						edit(oldVal, newVal, 'islink')
					})
				}
				document.getElementById("conetent").className = "weui-cells weui-cells_form"

			}
			var vm = new Vue({
				el: '#conetent',
				data: {
					editName: '',
					iswrite_all: 1,
					cname: {
						title: "栏目名称",
						message: ""
					},
					linkurl: {
						title: "链接url",
						message: ""
					},
					orderid: {
						title: "排序ID",
						message: ""
					},
					islink: {
						title: "是否为链接",
						check: true
					},
					iswrite: {
						title: "是否允许投稿",
						check: false
					},
					istop: {
						title: "是否显示首页",
						check: false
					},
					note: {
						title: "备注",
						message: ""
					}
				},
				methods: {
					resetData: function() { //重置数据
						Object.assign(this.$data, getDefaultData());
					},
					submitClick: function() {
						//						alert(99);
						//提交前先判断。如果都不为空，则允许提交
						/**
						 * 得到各input输入框的值
						 */
						var attendAdressValue = document.getElementById("attendAdressText").value;
						//alert("attendAdressValue==="+attendAdressValue);
						var attendAdressX = document.getElementById("longitude").value;
						var attendAdressY = document.getElementById("latitude").value;
						var attendAddressRedius = document.getElementById("attendAddressRedius").value;
						//						alert("attendAddressRedius=="+attendAddressRedius);
						if(attendAdressValue == "") {
							alert("考勤地点名称不能为空！");
							return;
						} else if(attendAdressX == "") {
							alert("考勤地点X坐标不能为空！");
							return;
						} else if(attendAdressY == "") {
							alert("考勤地点Y坐标不能为空！");
							return;
						} else if(attendAddressRedius == "") {
							alert("考勤地点半径不能为空！");
							return;
						} else {
							//input 输入框的值都填写了，则提交，进行添加。
							var tempData = {
								"corpId": corpId,
								"areaName": attendAdressValue,
								"areaX": attendAdressX,
								"areaY": attendAdressY,
								"areaRedius": attendAddressRedius,
								"uuid": "",
								"appid": "",
								"token": "",
								"sign": ""
							}
							$.ajax({
								url: "https://jbyj.jiaobaowang.net/AttendanceService/addAttendArea",
								type: "POST",
								data: JSON.stringify(tempData),
								timeout: 1000,
								dataType: "json",
								async: false,
								success: function(data) {
									console.log("新增考勤地点接口返回的情况======" + JSON.stringify(data));
									/**
									 * 如果接口返回正常，则跳转到显示考勤地点页面
									 */
									if(data.RspCode == 0) {
										//给用户提示，添加成功
										alert("添加成功");
										//									window.location="../pcWeb-HUI/attendenceManage_address.html";
										//										vm.resetData();
										//										vm.editName = '添加'
										//清空input输入框
										document.getElementById("attendAdressText").value = "";
										document.getElementById("longitude").value = "";
										document.getElementById("latitude").value = "";
										document.getElementById("attendAddressRedius").value = "";

									}else if(data.RspCode == 1017){
										alert("存在同名的考勤地点");
									}
								},
								error: function() {
									$.toast("状态错误，请重新进入APP", "cancel", function() {
										console.log('close');
									});
								}
							})
						}

						//						if(vm.type == 'add') { //添加栏目
						//							alert(000)
						//							var para = {
						//								cmd: 'chn',
						//								type: 'add',
						//								cname: vm.cname.message,
						//								islink: boolToInt(vm.islink.check),
						//								linkurl: vm.linkurl.message,
						//								iswrite: boolToInt(vm.iswrite.check),
						//								note: vm.note.message,
						//								orderid: vm.orderid.message,
						//								pid: 0,
						//								istop: boolToInt(vm.istop.check)
						//							}
						//							if(para.cname==""){
						//								alert("请输入栏目名称");
						//								return;
						//							}
						//							if(para.islink==1&&para.linkurl==''){
						//								alert("请输入链接地址");
						//								return;
						//							}
						//							if(para.note==""){
						//								alert("请输入备注");
						//								return;
						//							}
						//
						//							var reg = /^[1-9]\d*$/
						//								var numFlag = reg.test(vm.orderid.message);
						//								if(numFlag == false) {
						//									alert('请输入正确排序ID')
						//									return;
						//								}
						//							
						//							
						//							//							alert(JSON.stringify(para))
						//							unitWebsitePro(para, function(data) {
						//								if(data.RspCode == 0) {
						//									alert('添加成功');
						//									vm.resetData();
						//									vm.editName = '添加'
						////									mui.back()
						//								}
						//								//								alert(JSON.stringify(data));
						//							});
						//						} else if(vm.type == 'edit') { //删除栏目
						//							var para = {
						//								cmd: 'chn',
						//								type: 'del',
						//								colid: vm.colid
						//							}
						//							//							alert(JSON.stringify(para))
						//							unitWebsitePro(para, function(data) {
						//								if(data.RspCode == 0) {
						//									vm.resetData();
						////									mui.back()
						//								}
						//								//								alert(JSON.stringify(data));
						//							});
						//						}

					}
				}

			})

			function getDefaultData() {
				return {
					editName: '',
					cname: {
						title: "栏目名称",
						message: ""
					},
					linkurl: {
						title: "链接url",
						message: ""
					},
					orderid: {
						title: "排序ID",
						message: ""
					},
					islink: {
						title: "是否为链接",
						check: true
					},
					iswrite: {
						title: "是否允许投稿",
						check: false
					},
					note: {
						title: "备注",
						message: ""
					}
				}
			}

			function edit(oldVal, newVal, key) {
				console.log('key=' + key + '--oldVal=' + oldVal + '--newVal=' + newVal)
				if(vm.type == "orderid") {
					var numFlag = newVal.test('^[0-9]*$');
					console.log(numFlag)
					if(numFlag == false) {
						console.log('请输入正确的数字')
					}
				}
				if(vm.type == "add" && key == 'islink') {
					if(newVal == true) {
						$("#linkurl").focus();
						vm.iswrite.check = false;
					}
					return;

				}
				if(key == 'islink' && newVal == true) {

					$("#linkurl").focus();
					vm.iswrite.check = false;
				}
				if(newVal == oldVal) {
					return;
				}
				var para = {
					cmd: 'chn',
					type: 'edit',
					colid: vm.colid,
					callcol: key,
					colv: boolToInt(newVal)
				}
				console.log(JSON.stringify(para))
				unitWebsitePro(para, function(data) {
					//					alert(JSON.stringify(data));
				});
			}

			function boolToInt(value) {
				if(value == true) {
					return 1;
				} else if(value == false) {
					return 0;
				} else {
					return value;
				}

			}
			// 百度地图API功能
			var map = new BMap.Map("allmap");
			var point = new BMap.Point(116.331398, 39.897445);
			map.centerAndZoom(point, 12);
			map.enableScrollWheelZoom(true);
			//添加地图类型控件
			map.addControl(new BMap.MapTypeControl({
				mapTypes: [
					BMAP_NORMAL_MAP,
					BMAP_HYBRID_MAP
				]
			}));
			var top_left_control = new BMap.ScaleControl({
				anchor: BMAP_ANCHOR_BOTTOM_RIGHT
			}); // 左上角，添加比例尺
			var top_left_navigation = new BMap.NavigationControl({
				anchor: BMAP_ANCHOR_BOTTOM_RIGHT

			}); //左上角，添加默认缩放平移控件
			map.addControl(top_left_control);
			map.addControl(top_left_navigation);

			/**
			 * 城市列表控件
			 */
			map.enableInertialDragging();

			map.enableContinuousZoom();

			var size = new BMap.Size(10, 20);
			map.addControl(new BMap.CityListControl({
				anchor: BMAP_ANCHOR_TOP_LEFT,
				offset: size,
				// 切换城市之间事件
				// onChangeBefore: function(){
				//    alert('before');
				// },
				// 切换城市之后事件
				// onChangeAfter:function(){
				//   alert('after');
				// }
			}));
			/**
			 * 根据浏览器定位
			 */
			var geolocation = new BMap.Geolocation();
			geolocation.getCurrentPosition(function(r) {
				if(this.getStatus() == BMAP_STATUS_SUCCESS) {
					var mk = new BMap.Marker(r.point);
					map.addOverlay(mk);
					map.panTo(r.point);
					//					alert('您的位置：' + r.point.lng + ',' + r.point.lat);
				} else {
					alert('failed' + this.getStatus());
				}
			}, {
				enableHighAccuracy: true
			})

			var geoc = new BMap.Geocoder();
			/**
			 * 监听用户在地图上的点击事件
			 */
			map.addEventListener("click", function(e) {
				//通过点击百度地图，可以获取到对应的point, 由point的lng、lat属性就可以获取对应的经度纬度     
				var pt = e.point;
				geoc.getLocation(pt, function(rs) {
					//addressComponents对象可以获取到详细的地址信息
					var addComp = rs.addressComponents;
					var site = addComp.province + ", " + addComp.city + ", " + addComp.district + ", " + addComp.street + ", " + addComp.streetNumber;
					//将对应的HTML元素设置值
					document.getElementById("attendAdressText").value = site;
					document.getElementById("longitude").value = pt.lng;
					document.getElementById("latitude").value = pt.lat;
					$("#site").val(site);
					$("#longitude").val(pt.lng);
					$("#latitude").val(pt.lat);
					//          alert("pt.lng=="+pt.lng);
					//           alert("pt.lat=="+pt.lat);
				});
			});
		</script>
	</body>

</html>